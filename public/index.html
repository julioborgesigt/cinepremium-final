<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self'; font-src 'self' data:;">
  <title>CinePremium Edit</title>
  <style>
    /* Estilos globais */
    body {
      background: url("/cinepremium2.png") no-repeat center center fixed;
      background-size: cover;
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #000;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-height: 1000px;
      position: relative;
    }
    /* Cabe√ßalho normal */
    #cabe√ßalho img {
      width: 100%;
      display: block;
      border-radius: 10px;
    }
    /* Cabe√ßalho redondo (sobreposto) */
    #cabe√ßalhoredondo {
      position: relative;
      left: 50%;
      transform: translateX(-50%);
      top: -40px; /* Ajuste conforme o efeito desejado */
      z-index: 2;
      text-align: center;
    }
    #cabe√ßalhoredondo img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
    }
    h1, h2, h3 {
      text-align: center;
      color: #fff;
    }
    /* Grid de produtos */
    .product-grid {
      padding: 30px;
      display: flex;
      margin-top: 0px;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }
    .product-card {
      width: 200px;
      border: 1px solid #7a7a7a;
      border-radius: 8px;
      background: #4e4e4e;
      overflow: hidden;
      text-align: center;
      padding: 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: #fff;
    }
    .product-card img {
      max-width: 100%;
      max-height: 100px;
      margin: auto;
    }
    .button {
      display: inline-block;
      padding: 8px 12px;
      background: #823cd3;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 5px;
    }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .button:hover:not(:disabled) {
      background: #872bf1;
    }
    /* √Årea de checkout */
    .purchase-container {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    .purchase-container input {
      padding: 8px;
      margin: 5px;
      width: 80%;
      max-width: 300px;
    }
    .qr-section img {
      max-width: 200px; /* ou 200px, conforme desejado */
      height: auto;
      margin: auto;
    }
    
    .copy-info {
      font-size: 14px;
      color: #fff;
      margin-top: 10px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    }
    
    /* Estilos para exibi√ß√£o do c√≥digo PIX */
    .pix-code-display {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 8px;
      margin: 20px auto;
      max-width: 600px;
      border: 1px solid #823cd3;
    }
    .pix-code-text {
      font-family: monospace;
      font-size: 11px;
      color: #fff;
      word-break: break-all;
      margin: 0;
      line-height: 1.6;
      text-align: center;
    }
    .qr-code-container {
      text-align: center;
    }
    .confirmation-text {  
      font-size: 14px;
      color: white;
    }
    .status-feedback {
      font-size: 16px;
      font-weight: bold;
      margin-top: 10px;
      color: white; /* ADICIONADO */
    }
    /* Rodap√© */
    footer.footer {
      border-top: 1px solid #444;
      padding: 10px 0;
      margin-top: 200px;
      color: #fff;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    footer.footer .email-icon {
      display: inline-block;
      vertical-align: middle;
    }
    footer.footer .email-icon svg {
      width: 16px;
      height: 16px;
      fill: #fff;
    }
    /* Estiliza√ß√£o para a p√°gina de agradecimento */
    .thank-you-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .thank-you-card {
      background-color: #1c1c1c;
      border-radius: 8px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    
    .check-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
    }
    .check-icon svg {
      width: 100%;
      height: 100%;
      fill: #4CAF50;
    }
    .thank-you-card h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .thank-you-card p {
      margin: 5px 0;
      font-size: 16px;
      line-height: 1.4;
      color: #fff; /* Texto branco */
    }
    .transaction-id {
      color: #4CAF50;
      font-weight: bold;
      word-wrap: break-word;
    }
    .thank-you-card .button {
      margin-top: 20px;
      background-color: #4CAF50;
      color: #fff;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }
    .thank-you-card .button:hover {
      background-color: #43a047;
    }

    .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #ff5252; /* Vermelho ou outra cor de erro */
    color: #fff;
    padding: 15px 20px;
    border-radius: 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
    max-width: 90%;
    word-wrap: break-word;
    }
    .toast.show {
      opacity: 1;
    }

    /* NOVO: Estilos para feedback de valida√ß√£o nos inputs */
    .input-valid {
      border: 2px solid #28a745 !important; /* Borda verde */
    }
    .input-invalid {
      border: 2px solid #dc3545 !important; /* Borda vermelha */
    }

    /* NOVO: Estilos para o Loading Spinner */
    .loading-spinner {
      display: none; /* Escondido por padr√£o */
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3; /* Light grey */
      border-top: 4px solid #823cd3; /* Blue */
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto; /* Centraliza horizontalmente e adiciona espa√ßo */
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* NOVO: Classe para desabilitar visualmente o bot√£o enquanto carrega */
    .button.loading {
      opacity: 0.7;
      cursor: not-allowed;
    }

    /* Responsividade para dispositivos m√≥veis */
    @media (max-width: 900px) {
      #cabe√ßalhoredondo img {
        width: 90px;
        height: 90px;
      }
    }
    @media (max-width: 768px) {
      #cabe√ßalhoredondo img {
        width: 80px;
        height: 80px;
      }
    }
    @media (max-width: 600px) {
      body {
        margin: 10px;
      }
      .container {
        padding: 10px;
        min-height: auto;
      }
      #cabe√ßalhoredondo {
        top: -10px;
      }
      #cabe√ßalhoredondo img {
        width: 60px;
        height: 60px;
      }
      .product-grid {
        padding: 10px;
        gap: 10px;
        flex-direction: column;
        align-items: center;
      }
      .product-card {
        width: 90%;
        max-width: 300px;
      }
      .purchase-container input {
        width: 90%;
      }
      footer.footer {
        flex-direction: column;
        text-align: center;
        margin-top: 100px;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="mainContainer">
    <div id="cabe√ßalho">  
      <img src="/CInePremium1.png" alt="Imagem de Cabe√ßalho">
    </div>
    <div id="cabe√ßalhoredondo">
      <img src="/cinepremiumredondo.png" alt="Imagem Redonda">
    </div>
    <div id="productGrid" class="product-grid">
      </div>
    <div id="purchaseContainer" class="purchase-container">
      <h1>Detalhes da Compra</h1>
      <h2><p id="productInfo"></p></h2>
      <input type="text" id="nome" placeholder="Digite seu nome completo">
      <input type="tel" id="telefone" placeholder="Digite seu telefone (DDD + n√∫mero)">
      <input type="text" id="cpf" placeholder="Digite seu CPF (apenas n√∫meros)">
      <input type="email" id="email" placeholder="Digite seu e-mail">
      <br>
      <button id="generateBtn" class="button" disabled>Gerar QR Code</button>
      <div id="loadingSpinner" class="loading-spinner"></div> 
      <div id="qrDisplay" class="qr-section" style="display: none;">
        <h3 style="color: #fff; margin-bottom: 20px;">Pagamento via QR Code</h3>
        
        <!-- QR Code -->
        <div class="qr-code-container" style="text-align: center; margin-bottom: 20px;">
          <div id="qrCodeImg"></div>
        </div>
        
        <!-- C√≥digo PIX Copia e Cola -->
        <div class="pix-code-display" style="margin: 20px 0;">
          <p id="qrCodeText" class="pix-code-text"></p>
        </div>
        
        <!-- ID da Transa√ß√£o -->
        <p id="transactionId" class="copy-info" style="margin: 15px 0; text-align: center;"></p>
        
        <!-- Bot√£o Copiar C√≥digo -->
        <div style="text-align: center; margin: 20px 0;">
          <button id="copyBtn" class="button">Copiar C√≥digo</button>
        </div>
        
        <!-- Status do Pagamento -->
        <p id="paymentStatus" class="status-feedback" style="text-align: center;"></p>
      </div>
      <button id="backBtn" class="button" style="margin-top:15px;">Voltar aos Produtos</button>
    </div>
    <footer class="footer">
      <span>&copy; 2025 - Todos os direitos reservados</span>
      <span class="email-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
        </svg>
      </span>
      <span>cinepremium.sac@gmail.com</span>
    </footer>
  </div>
  
  <script>
    let selectedProduct = null;
    let transactionId = null;
    let pollingInterval = null;
    let pollingTimeout = null; // NOVO: Timeout para parar polling ap√≥s 10 minutos
    let qrCodeExpirationTimestamp = null; // NOVO: Vari√°vel para guardar o tempo de expira√ß√£o

    // CSRF Token cache
    let csrfToken = null;

    // Fun√ß√£o para obter CSRF token
    async function getCsrfToken() {
      if (!csrfToken) {
        try {
          const response = await fetch('/api/csrf-token');
          if (!response.ok) {
            throw new Error('Erro ao obter CSRF token');
          }
          const data = await response.json();
          csrfToken = data.csrfToken;
        } catch (error) {
          console.error('Erro ao obter CSRF token:', error);
          throw error;
        }
      }
      return csrfToken;
    }

    // NOVO: Fun√ß√£o completa para validar CPF
    function isValidCPF(cpf) {
      if (typeof cpf !== 'string') return false;
      cpf = cpf.replace(/[^\d]+/g, ''); // Remove caracteres n√£o num√©ricos

      if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
        return false; // Verifica se tem 11 d√≠gitos ou se s√£o todos repetidos
      }

      let sum = 0;
      let remainder;

      // Valida√ß√£o do primeiro d√≠gito verificador
      for (let i = 1; i <= 9; i++) {
        sum += parseInt(cpf.substring(i - 1, i)) * (11 - i);
      }
      remainder = (sum * 10) % 11;
      if ((remainder === 10) || (remainder === 11)) {
        remainder = 0;
      }
      if (remainder !== parseInt(cpf.substring(9, 10))) {
        return false;
      }

      // Valida√ß√£o do segundo d√≠gito verificador
      sum = 0;
      for (let i = 1; i <= 10; i++) {
        sum += parseInt(cpf.substring(i - 1, i)) * (12 - i);
      }
      remainder = (sum * 10) % 11;
      if ((remainder === 10) || (remainder === 11)) {
        remainder = 0;
      }
      if (remainder !== parseInt(cpf.substring(10, 11))) {
        return false;
      }
      
      return true;
    }

    // Valida se o email tem um formato b√°sico
    function isValidEmail(email) {
      const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      return re.test(String(email).toLowerCase());
    }

    // Habilita o bot√£o "Gerar QR Code" se os campos estiverem preenchidos
    function validateCheckoutFields() {
      const nome = document.getElementById('nome').value.trim();
      const telefoneDigits = document.getElementById('telefone').value.replace(/\D/g, "");
      const cpf = document.getElementById('cpf').value;
      const email = document.getElementById('email').value.trim();
      
      // A condi√ß√£o agora chama a fun√ß√£o isValidCPF()
      document.getElementById('generateBtn').disabled = !(nome && telefoneDigits.length === 11 && isValidCPF(cpf) && isValidEmail(email));
    }
    
    // Carrega os produtos do endpoint /api/products
    // CORRIGIDO: Removido innerHTML para prevenir XSS
    let cachedProducts = null; // Cache de produtos para evitar requisi√ß√µes duplicadas

    async function loadProducts() {
      try {
        const response = await fetch('/api/products');
        cachedProducts = await response.json();
        const grid = document.getElementById('productGrid');
        grid.innerHTML = '';

        cachedProducts.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';

          // Cria imagem
          const img = document.createElement('img');
          img.src = product.image;
          img.alt = product.title;
          img.onerror = function() { this.src = '/cinepremiumredondo.png'; }; // Fallback

          // Cria t√≠tulo
          const title = document.createElement('h3');
          title.textContent = product.title;

          // Cria pre√ßo
          const price = document.createElement('p');
          price.textContent = `R$ ${(product.price/100).toFixed(2)}`;

          // Cria bot√£o
          const button = document.createElement('button');
          button.className = 'button';
          button.textContent = 'Comprar';
          button.addEventListener('click', () => selectProduct(product.id));

          // Monta o card
          card.appendChild(img);
          card.appendChild(title);
          card.appendChild(price);
          card.appendChild(button);

          grid.appendChild(card);
        });
      } catch (error) {
        if (typeof console !== 'undefined' && console.error) {
          console.error('Erro ao carregar produtos:', error);
        }
        showErrorToast('Erro ao carregar produtos. Tente novamente.');
      }
    }
    
    // Seleciona um produto e inicia o fluxo de checkout
    // CORRIGIDO: Usa cache ao inv√©s de nova requisi√ß√£o
    function selectProduct(productId) {
      try {
        // Usa o cache de produtos ao inv√©s de nova requisi√ß√£o
        if (!cachedProducts) {
          showErrorToast('Erro ao carregar produtos. Recarregue a p√°gina.');
          return;
        }

        selectedProduct = cachedProducts.find(p => p.id == productId);
        if (!selectedProduct) {
          showErrorToast('Produto n√£o encontrado');
          return;
        }

        // Usa textContent para seguran√ßa
        const productInfo = document.getElementById('productInfo');
        productInfo.textContent =
          `${selectedProduct.title} - ${selectedProduct.description || ''} por R$ ${(selectedProduct.price/100).toFixed(2)}`;

        document.getElementById('productGrid').style.display = 'none';
        document.getElementById('purchaseContainer').style.display = 'block';
        document.getElementById('qrDisplay').style.display = 'none';
        transactionId = null;
        qrCodeExpirationTimestamp = null;

        if (pollingInterval) clearInterval(pollingInterval);

        // Limpa os campos de checkout e desabilita o bot√£o
        document.getElementById('nome').value = '';
        document.getElementById('telefone').value = '';
        document.getElementById('cpf').value = '';
        document.getElementById('email').value = '';

        // Remove classes de valida√ß√£o visual
        ['nome', 'telefone', 'cpf', 'email'].forEach(id => {
          document.getElementById(id).classList.remove('input-valid', 'input-invalid');
        });

        validateCheckoutFields();
      } catch (error) {
        if (typeof console !== 'undefined' && console.error) {
          console.error('Erro ao selecionar produto:', error);
        }
        showErrorToast('Erro ao selecionar produto');
      }
    }
    
    // Bot√£o para voltar ao grid de produtos
    document.getElementById('backBtn').addEventListener('click', function() {
      document.getElementById('purchaseContainer').style.display = 'none';
      document.getElementById('productGrid').style.display = 'flex';
      qrCodeExpirationTimestamp = null; // MODIFICADO: Reseta o timestamp ao voltar
      if (pollingInterval) clearInterval(pollingInterval);
    });
    // MODIFICADO: A fun√ß√£o agora verifica o tempo antes de fazer a requisi√ß√£o
    // Verifica o status do pagamento periodicamente
    async function checkPaymentStatus() {
       // NOVO: Bloco que verifica se o QR Code expirou
      if (qrCodeExpirationTimestamp && Date.now() > qrCodeExpirationTimestamp) {
        console.log('[POLLING] ‚è±Ô∏è QR Code expirou');
        document.getElementById('paymentStatus').textContent = 'Seu QR Code expirou. Por favor, volte e gere um novo.';
        clearInterval(pollingInterval); // Para a verifica√ß√£o
        return; // Sai da fun√ß√£o
      }
      if (!transactionId) return;

      try {
        console.log('[POLLING] üîÑ Verificando status do pagamento...', transactionId);

        // Obt√©m CSRF token
        const token = await getCsrfToken();

        const response = await fetch('/check-local-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'CSRF-Token': token
          },
          body: JSON.stringify({ id: transactionId })
        });

        // Se CSRF inv√°lido, recarrega token e tenta novamente
        if (response.status === 403) {
          console.warn('[POLLING] ‚ö†Ô∏è CSRF inv√°lido, renovando token...');
          csrfToken = null;
          const newToken = await getCsrfToken();
          const retryResponse = await fetch('/check-local-status', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'CSRF-Token': newToken
            },
            body: JSON.stringify({ id: transactionId })
          });

          if (!retryResponse.ok) {
            throw new Error('Erro ao verificar status');
          }
          const data = await retryResponse.json();
          console.log('[POLLING] üìä Status recebido (ap√≥s retry):', data.status);
          processPaymentStatus(data);
        } else if (!response.ok) {
          console.error('[POLLING] ‚ùå Erro na resposta:', response.status);
          throw new Error('Erro ao verificar status');
        } else {
          const data = await response.json();
          console.log('[POLLING] üìä Status recebido:', data.status);
          processPaymentStatus(data);
        }
      } catch (error) {
        console.error('[POLLING] ‚ùå Erro ao verificar status:', error);
      }
    }

    // NOVO: Fun√ß√£o auxiliar para processar status do pagamento
    function processPaymentStatus(data) {
      console.log('[PAYMENT] üìä Processando status:', data);

      if (data.status && data.status.toLowerCase() === 'sucesso') {
        console.log('[PAYMENT] ‚úÖ PAGAMENTO CONFIRMADO! Exibindo p√°gina de agradecimento...');

        // Para o polling
        if (pollingInterval) {
          clearInterval(pollingInterval);
          console.log('[PAYMENT] üõë Polling interrompido');
        }

        // CORRIGIDO: Cria elementos DOM ao inv√©s de innerHTML para prevenir XSS
        const mainContainer = document.getElementById('mainContainer');
        mainContainer.innerHTML = ''; // Limpa o conte√∫do

        const thankYouContainer = document.createElement('div');
        thankYouContainer.className = 'thank-you-container';

        const thankYouCard = document.createElement('div');
        thankYouCard.className = 'thank-you-card';

        const title = document.createElement('h1');
        title.textContent = 'Obrigado pela sua compra!';

        const confirmText = document.createElement('p');
        confirmText.textContent = 'Sua transa√ß√£o foi confirmada.';

        const transactionText = document.createElement('p');
        transactionText.textContent = 'ID da Transa√ß√£o: ';

        const transactionSpan = document.createElement('span');
        transactionSpan.className = 'transaction-id';
        transactionSpan.textContent = transactionId;
        transactionText.appendChild(transactionSpan);

        const backButton = document.createElement('button');
        backButton.className = 'button';
        backButton.textContent = 'Voltar √† P√°gina Inicial';
        backButton.addEventListener('click', () => { window.location.href = '/'; });

        thankYouCard.appendChild(title);
        thankYouCard.appendChild(confirmText);
        thankYouCard.appendChild(transactionText);
        thankYouCard.appendChild(backButton);

        thankYouContainer.appendChild(thankYouCard);
        mainContainer.appendChild(thankYouContainer);

        // Limpa polling e timeout
        clearInterval(pollingInterval);
        if (pollingTimeout) clearTimeout(pollingTimeout);
      } else {
        document.getElementById('paymentStatus').textContent = 'Aguardando confirma√ß√£o do pagamento...';
      }
    }
    
    // Gera o QR Code de pagamento, enviando tamb√©m os dados do cliente
    // Substitua todo o bloco 'generateBtn' por este

document.getElementById('generateBtn').addEventListener('click', async function() {
  if (!selectedProduct) return;

  const nome = document.getElementById('nome').value.trim();
  const telefone = document.getElementById('telefone').value.trim();
  const cpf = document.getElementById('cpf').value.trim();
  const email = document.getElementById('email').value.trim();

  document.getElementById('loadingSpinner').style.display = 'block';
  this.disabled = true;
  this.classList.add('loading');

  // LOG 1: Confirma que o processo iniciou
  console.log('[P√°gina de Venda] Bot√£o clicado. Tentando gerar QR Code...');

  try {
    // Obt√©m CSRF token
    const token = await getCsrfToken();

    const response = await fetch('/gerarqrcode', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'CSRF-Token': token
      },
      body: JSON.stringify({
        value: selectedProduct.price,
        nome, telefone, cpf, email,
        productTitle: selectedProduct.title,
        productDescription: selectedProduct.description || ''
      })
    });

    // LOG 2: Mostra o status da resposta do servidor
    console.log('[P√°gina de Venda] Resposta inicial do servidor recebida. Status:', response.status, response.statusText);

    // Se CSRF inv√°lido, recarrega token e tenta novamente
    if (response.status === 403) {
      csrfToken = null;
      const newToken = await getCsrfToken();
      const retryResponse = await fetch('/gerarqrcode', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'CSRF-Token': newToken
        },
        body: JSON.stringify({
          value: selectedProduct.price,
          nome, telefone, cpf, email,
          productTitle: selectedProduct.title,
          productDescription: selectedProduct.description || ''
        })
      });

      if (!retryResponse.ok) {
        const errorData = await retryResponse.json().catch(() => retryResponse.text());
        console.error('[P√°gina de Venda] O servidor retornou um erro:', errorData);
        const errorMessage = errorData.error || (errorData.msg && Object.values(errorData.msg)[0]) || 'Ocorreu um erro desconhecido.';
        throw new Error(errorMessage);
      }

      const data = await retryResponse.json();
      processQRCodeResponse(data);
      return;
    }

    if (!response.ok) {
      const errorData = await response.json().catch(() => response.text());
      // LOG 3: Mostra o erro exato vindo do servidor
      console.error('[P√°gina de Venda] ‚ùå ERRO DO SERVIDOR:');
      console.error('  - Mensagem:', errorData.error);
      console.error('  - Gateway:', errorData.gateway);
      console.error('  - C√≥digo HTTP:', errorData.httpCode);
      console.error('  - Detalhes completos:', JSON.stringify(errorData.details, null, 2));
      console.error('  - Resposta completa:', errorData);
      const errorMessage = errorData.error || (errorData.msg && Object.values(errorData.msg)[0]) || 'Ocorreu um erro desconhecido.';
      throw new Error(errorMessage);
    }

    const data = await response.json();
    processQRCodeResponse(data);

  } catch (error) {
    // LOG 5: Captura qualquer outro erro que possa ocorrer
    console.error('[P√°gina de Venda] Erro capturado no bloco CATCH:', error);
    showErrorToast(error.message);
  } finally {
    document.getElementById('loadingSpinner').style.display = 'none';
    this.disabled = false;
    this.classList.remove('loading');
  }
});

    // NOVO: Fun√ß√£o auxiliar para processar resposta do QR Code
    function processQRCodeResponse(data) {
      // LOG 4: Confirma o sucesso e o disparo da notifica√ß√£o
      console.log('[P√°gina de Venda] QR Code recebido do servidor. A notifica√ß√£o para o admin foi disparada neste momento.');

      // O resto do seu c√≥digo de sucesso...
      document.getElementById('qrDisplay').style.display = 'block';
      document.getElementById('nome').style.display = 'none';
      document.getElementById('telefone').style.display = 'none';
      document.getElementById('cpf').style.display = 'none';
      document.getElementById('email').style.display = 'none';
      document.getElementById('generateBtn').style.display = 'none';

      // CORRIGIDO: Valida e cria imagem com createElement
      const qrCodeImgContainer = document.getElementById('qrCodeImg');
      qrCodeImgContainer.innerHTML = ''; // Limpa conte√∫do anterior

      // Valida√ß√£o b√°sica do base64
      if (data.qr_code_base64 && typeof data.qr_code_base64 === 'string') {
        const qrImg = document.createElement('img');
        qrImg.alt = 'QR Code de Pagamento';
        qrImg.style.width = '200px';
        qrImg.style.height = '200px';
        qrImg.onerror = function() {
          showErrorToast('Erro ao carregar QR Code. Tente novamente.');
        };
        qrImg.src = 'data:image/png;base64,' + data.qr_code_base64;
        qrCodeImgContainer.appendChild(qrImg);
      }

      document.getElementById('qrCodeText').textContent = data.qr_code;
      transactionId = data.id;
      qrCodeExpirationTimestamp = data.expirationTimestamp;
      document.getElementById('transactionId').textContent = 'ID da Transa√ß√£o: ' + transactionId;

      console.log('‚úÖ [QR CODE] QR Code gerado com sucesso!');
      console.log('  - Transaction ID:', transactionId);
      console.log('  - Expira em:', new Date(qrCodeExpirationTimestamp).toLocaleString());

      // Limpa polling anterior se existir
      if (pollingInterval) clearInterval(pollingInterval);
      if (pollingTimeout) clearTimeout(pollingTimeout);

      console.log('[POLLING] üöÄ Iniciando polling a cada 5 segundos...');
      console.log('[POLLING] ‚è±Ô∏è Polling ser√° interrompido ap√≥s 10 minutos');

      // Inicia novo polling
      pollingInterval = setInterval(checkPaymentStatus, 5000);

      // NOVO: Para o polling automaticamente ap√≥s 10 minutos (DoS prevention)
      pollingTimeout = setTimeout(() => {
        clearInterval(pollingInterval);
        console.log('[POLLING] ‚è±Ô∏è Timeout de 10 minutos atingido. Polling interrompido.');
        document.getElementById('paymentStatus').textContent =
          'Tempo limite de verifica√ß√£o excedido. Recarregue a p√°gina e gere um novo QR Code se necess√°rio.';
        document.getElementById('paymentStatus').style.color = '#ff9800'; // Laranja
      }, 10 * 60 * 1000); // 10 minutos

      console.log('\nüì± Aguardando pagamento via Pix...');
      console.log('üí° Dicas de debug:');
      console.log('  - Acompanhe os logs [POLLING] para ver as verifica√ß√µes de status');
      console.log('  - Quando o pagamento for confirmado, voc√™ ver√° [PAYMENT] ‚úÖ PAGAMENTO CONFIRMADO');
      console.log('  - Para simular um pagamento, use a p√°gina de admin');
    }
    
    // CORRIGIDO: Substitu√≠do alert() por toast notification
    document.getElementById('copyBtn').addEventListener('click', function() {
      const qrCodeText = document.getElementById('qrCodeText').textContent;
      navigator.clipboard.writeText(qrCodeText)
        .then(() => {
          // Cria toast de sucesso (verde)
          const toast = document.createElement('div');
          toast.className = 'toast';
          toast.style.background = '#4CAF50'; // Verde para sucesso
          toast.textContent = 'C√≥digo copiado para a √°rea de transfer√™ncia!';
          document.body.appendChild(toast);
          void toast.offsetWidth;
          toast.classList.add('show');
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
              document.body.removeChild(toast);
            }, 500);
          }, 2000);
        })
        .catch(err => {
          if (typeof console !== 'undefined' && console.error) {
            console.error('Erro ao copiar:', err);
          }
          showErrorToast('Erro ao copiar c√≥digo');
        });
    });
    
    window.onload = loadProducts;
    
    // Fun√ß√µes de formata√ß√£o de telefone e CPF (j√° existentes)
    function formatPhone(value) {
      value = value.replace(/\D/g, "").substring(0, 11);
      if (value.length > 0) value = "(" + value;
      if (value.length > 3) value = value.slice(0, 3) + ") " + value.slice(3);
      if (value.length > 10) value = value.slice(0, 10) + "-" + value.slice(10);
      return value;
    }

    function formatCPF(value) {
      value = value.replace(/\D/g, "").substring(0, 11);
      if (value.length > 3) value = value.slice(0, 3) + "." + value.slice(3);
      if (value.length > 7) value = value.slice(0, 7) + "." + value.slice(7);
      if (value.length > 11) value = value.slice(0, 11) + "-" + value.slice(11);
      return value;
    }
    
    document.getElementById('telefone').addEventListener('input', validateCheckoutFields);
    document.getElementById('cpf').addEventListener('input', validateCheckoutFields);
    document.getElementById('email').addEventListener('input', validateCheckoutFields);
    document.getElementById('nome').addEventListener('input', validateCheckoutFields);


    // MODIFICADO: O event listener do CPF agora tamb√©m d√° feedback visual
    document.getElementById('cpf').addEventListener('input', function(e) {
      // Primeiro, formata o CPF (adiciona pontos e tra√ßo)
      let value = e.target.value;
      value = value.replace(/\D/g, "").substring(0, 11);
      if (value.length > 3) value = value.slice(0, 3) + "." + value.slice(3);
      if (value.length > 7) value = value.slice(0, 7) + "." + value.slice(7);
      if (value.length > 11) value = value.slice(0, 11) + "-" + value.slice(11);
      e.target.value = value;
      
      // Segundo, valida e aplica o feedback visual
      const cpfInput = e.target;
      const cpfDigits = cpfInput.value.replace(/\D/g, "");

      if (cpfDigits.length === 11) {
        if (isValidCPF(cpfDigits)) {
          cpfInput.classList.add('input-valid');
          cpfInput.classList.remove('input-invalid');
        } else {
          cpfInput.classList.add('input-invalid');
          cpfInput.classList.remove('input-valid');
        }
      } else {
        cpfInput.classList.remove('input-valid', 'input-invalid');
      }

      // Por √∫ltimo, chama a valida√ß√£o geral dos campos
      validateCheckoutFields();
    });

    // NOVO: Adiciona a m√°scara de formata√ß√£o para o campo de telefone (j√° existente)
    document.getElementById('telefone').addEventListener('input', function (e) {
      let value = e.target.value;
      value = value.replace(/\D/g, ""); // Remove tudo que n√£o √© d√≠gito
      value = value.substring(0, 11); // Limita a 11 d√≠gitos

      // Aplica a m√°scara (xx) xxxxx-xxxx dinamicamente
      if (value.length > 6) {
        value = value.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
      } else if (value.length > 2) {
        value = value.replace(/^(\d{2})(\d{0,5}).*/, '($1) $2');
      } else if (value.length > 0) {
        value = value.replace(/^(\d*)/, '($1');
      }
      
      e.target.value = value;
    });

    function showErrorToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      void toast.offsetWidth;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 500);
      }, 4000);
    }
  </script>
</body>
</html>