<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.jsdelivr.net https://firebaseinstallations.googleapis.com https://fcmregistrations.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://www.gstatic.com https://firebaseinstallations.googleapis.com https://fcmregistrations.googleapis.com https://fcm.googleapis.com; font-src 'self' data:;">
  <title>Admin - Produtos</title>
  <style>
    /* Reset e Estilos Gerais */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    /* Header */
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    h1 {
      margin: 0;
      color: #2c3e50;
      font-size: 2rem;
      font-weight: 600;
    }

    .logout-link {
      padding: 10px 20px;
      background: #e74c3c;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .logout-link:hover {
      background: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }

    /* Se√ß√µes */
    .section {
      margin-bottom: 40px;
    }

    .section-title {
      color: #2c3e50;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
    }

    /* Formul√°rio */
    .form-card {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
    }

    .form-grid {
      display: grid;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    input[type="file"] {
      padding: 8px;
      cursor: pointer;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    button {
      padding: 14px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    /* Se√ß√£o Colaps√°vel */
    .collapsible-section {
      margin-bottom: 30px;
    }

    .collapse-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 15px 20px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
      user-select: none;
    }

    .collapse-header:hover {
      background: #e9ecef;
      border-color: #667eea;
    }

    .collapse-header h2 {
      margin: 0;
      color: #2c3e50;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .collapse-toggle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      transition: transform 0.3s ease;
    }

    .collapse-toggle.open {
      transform: rotate(180deg);
    }

    .collapse-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .collapse-content.open {
      max-height: 5000px;
      padding-top: 20px;
    }

    /* Lista de Produtos */
    .product-list {
      background: #f8f9fa;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      overflow: hidden;
    }

    .product-item {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 15px 20px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      transition: all 0.2s ease;
      cursor: move;
    }

    .product-item:last-child {
      border-bottom: none;
    }

    .product-item:hover {
      background: #f8f9fa;
      transform: translateX(5px);
    }

    .product-item.dragging {
      opacity: 0.5;
      background: #e9ecef;
    }

    .product-drag-handle {
      color: #95a5a6;
      font-size: 20px;
      cursor: grab;
    }

    .product-drag-handle:active {
      cursor: grabbing;
    }

    .product-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
    }

    .product-info {
      flex: 1;
      min-width: 0;
    }

    .product-title {
      font-weight: 600;
      color: #2c3e50;
      margin: 0 0 5px 0;
      font-size: 1.1rem;
    }

    .product-price {
      color: #27ae60;
      font-weight: 600;
      font-size: 1.1rem;
      margin: 0 0 5px 0;
    }

    .product-description {
      color: #7f8c8d;
      font-size: 0.9rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-actions {
      display: flex;
      gap: 10px;
    }

    .delete-button {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-button:hover {
      background: #c0392b;
      transform: scale(1.1);
    }

    .empty-state {
      padding: 40px;
      text-align: center;
      color: #95a5a6;
      font-size: 1.1rem;
    }

    /* Filtros de Hist√≥rico */
    .history-filters {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      margin-bottom: 20px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    #searchButton {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* Tabela de Hist√≥rico */
    .table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      background: white;
    }

    #historyResults table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    #historyResults th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      padding: 15px;
      text-align: left;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #historyResults td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
      color: #2c3e50;
    }

    #historyResults tr:last-child td {
      border-bottom: none;
    }

    #historyResults tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-sucesso {
      background: #d4edda;
      color: #155724;
    }

    .status-gerado {
      background: #fff3cd;
      color: #856404;
    }

    .status-falhou {
      background: #f8d7da;
      color: #721c24;
    }

    .status-expirado {
      background: #e2e3e5;
      color: #383d41;
    }

    .transaction-id {
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #6c757d;
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.3);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
      max-width: 400px;
      font-weight: 500;
    }

    .toast.show {
      opacity: 1;
    }

    .toast.success {
      background: linear-gradient(135deg, #28a745, #20c997);
    }

    .toast.error {
      background: linear-gradient(135deg, #dc3545, #c82333);
    }

    .toast.warning {
      background: linear-gradient(135deg, #ffc107, #ff9800);
    }

    /* Bot√£o de Notifica√ß√µes */
    .notification-button {
      background: linear-gradient(135deg, #28a745, #20c997);
      margin-bottom: 20px;
    }

    .notification-button:hover {
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    /* Responsividade */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 20px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .admin-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .logout-link {
        width: 100%;
        text-align: center;
      }

      .section-title {
        font-size: 1.25rem;
      }

      .filter-grid {
        grid-template-columns: 1fr;
      }

      .product-item {
        flex-wrap: wrap;
      }

      .product-info {
        flex: 1 1 100%;
        order: 3;
      }

      .product-image {
        width: 50px;
        height: 50px;
      }

      #historyResults {
        font-size: 0.9rem;
      }

      #historyResults th,
      #historyResults td {
        padding: 10px 8px;
      }

      .toast {
        left: 10px;
        right: 10px;
        max-width: none;
      }
    }

    @media (max-width: 480px) {
      .product-drag-handle {
        display: none;
      }

      .product-item {
        padding: 12px 15px;
      }

      #historyResults table {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="admin-header">
      <h1>üé¨ Painel de Administra√ß√£o</h1>
      <a href="/logout" class="logout-link">Sair</a>
    </div>

    <!-- Se√ß√£o: Adicionar Produto -->
    <div class="section">
      <h2 class="section-title">Adicionar Novo Produto</h2>
      <div class="form-card">
        <form id="productForm" class="form-grid">
          <div class="form-group">
            <label for="title">T√≠tulo do Produto</label>
            <input type="text" id="title" placeholder="Ex: Ingresso Cinema Premium" required>
          </div>

          <div class="form-group">
            <label for="price">Pre√ßo (em centavos)</label>
            <input type="number" id="price" placeholder="Ex: 2500 = R$ 25,00" required>
          </div>

          <div class="form-group">
            <label for="imageFile">Imagem do Produto</label>
            <input type="file" id="imageFile" accept="image/*" required>
            <input type="hidden" id="imageBase64">
          </div>

          <div class="form-group">
            <label for="description">Descri√ß√£o</label>
            <textarea id="description" placeholder="Descreva os detalhes do produto..."></textarea>
          </div>

          <button type="submit">‚ûï Adicionar Produto</button>
        </form>
      </div>
    </div>

    <!-- Se√ß√£o: Produtos Existentes (Colaps√°vel) -->
    <div class="collapsible-section">
      <div class="collapse-header" id="productsCollapseHeader">
        <h2>üì¶ Produtos Existentes</h2>
        <div class="collapse-toggle" id="productsToggle">‚ñº</div>
      </div>
      <div class="collapse-content" id="productsCollapseContent">
        <div class="product-list" id="productList"></div>
      </div>
    </div>

    <!-- Se√ß√£o: Hist√≥rico de Compras -->
    <div class="section">
      <h2 class="section-title">üìä Hist√≥rico de Compras</h2>

      <div class="history-filters">
        <div class="filter-grid">
          <div class="form-group">
            <label for="searchNome">Nome do Cliente</label>
            <input type="text" id="searchNome" placeholder="Buscar por nome...">
          </div>

          <div class="form-group">
            <label for="searchTelefone">Telefone</label>
            <input type="text" id="searchTelefone" placeholder="(00) 00000-0000">
          </div>

          <div class="form-group">
            <label for="mes">M√™s</label>
            <select id="mes"></select>
          </div>

          <div class="form-group">
            <label for="ano">Ano</label>
            <select id="ano"></select>
          </div>
        </div>
        <button id="searchButton">üîç Buscar</button>
      </div>

      <div id="historyResults"></div>
    </div>
  </div>
  <!--
    SEGURAN√áA: Scripts CDN com Subresource Integrity (SRI)

    Para gerar os hashes SRI, execute: node generate-sri.js
    Ou use: https://www.srihash.org/

    Adicione integrity="sha384-HASH_AQUI" quando tiver os hashes.
    O atributo crossorigin="anonymous" j√° est√° configurado.
  -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js" crossorigin="anonymous"></script>
  <script>
    // CSRF Token cache
    let csrfToken = null;

    // Fun√ß√£o para obter CSRF token
    async function getCsrfToken() {
      if (!csrfToken) {
        try {
          const response = await fetch('/api/csrf-token');
          if (!response.ok) {
            throw new Error('Erro ao obter CSRF token');
          }
          const data = await response.json();
          csrfToken = data.csrfToken;
        } catch (error) {
          console.error('Erro ao obter CSRF token:', error);
          throw error;
        }
      }
      return csrfToken;
    }

    // NOVO: Fun√ß√£o para exibir toast notifications
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      // For√ßa reflow para aplicar transi√ß√£o
      void toast.offsetWidth;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // MODIFICADO: Fun√ß√£o centralizada para fazer chamadas de API com CSRF e tratamento de sess√£o expirada
        async function authenticatedFetch(url, options = {}) {
            try {
                // Adiciona CSRF token em requisi√ß√µes que modificam dados (POST, PUT, DELETE)
                const method = options.method ? options.method.toUpperCase() : 'GET';
                if (['POST', 'PUT', 'DELETE'].includes(method)) {
                    const token = await getCsrfToken();
                    options.headers = {
                        ...options.headers,
                        'CSRF-Token': token
                    };
                }

                const response = await fetch(url, options);

                // Se a resposta for 403 e for um m√©todo que requer CSRF, tenta novamente com novo token
                if (response.status === 403 && ['POST', 'PUT', 'DELETE'].includes(method)) {
                    csrfToken = null; // Limpa token antigo
                    const newToken = await getCsrfToken();
                    options.headers = {
                        ...options.headers,
                        'CSRF-Token': newToken
                    };

                    const retryResponse = await fetch(url, options);

                    // Se ainda der 403, pode ser outro problema
                    if (retryResponse.status === 403) {
                        showToast('Erro de autentica√ß√£o. Recarregue a p√°gina.', 'error');
                        throw new Error('CSRF validation failed');
                    }

                    // Se agora for 401, sess√£o expirada
                    if (retryResponse.status === 401) {
                        const data = await retryResponse.json();
                        showToast(data.error || 'Sua sess√£o expirou, fa√ßa o login novamente.', 'error');
                        setTimeout(() => {
                          window.location.href = '/login';
                        }, 1500);
                        throw new Error('Sess√£o expirada');
                    }

                    return retryResponse;
                }

                // Se a resposta for 401 (N√£o Autorizado), a sess√£o expirou
                if (response.status === 401) {
                    const data = await response.json();
                    showToast(data.error || 'Sua sess√£o expirou, fa√ßa o login novamente.', 'error');
                    // Redireciona para a p√°gina de login
                    setTimeout(() => {
                      window.location.href = '/login';
                    }, 1500);
                    // Lan√ßa um erro para parar a execu√ß√£o do c√≥digo que chamou esta fun√ß√£o
                    throw new Error('Sess√£o expirada');
                }

                return response; // Se n√£o houver erro, retorna a resposta original
            } catch (error) {
                // Se o erro j√° for de sess√£o expirada, apenas o propaga
                if (error.message === 'Sess√£o expirada') {
                    throw error;
                }
                // Para outros erros de rede, etc.
                if (typeof console !== 'undefined' && console.error) {
                  console.error('Erro na chamada da API:', error);
                }
                showToast('Ocorreu um erro de comunica√ß√£o com o servidor.', 'error');
                throw error;
            }
        }


    // NOVO: Listener para converter a imagem selecionada para Base64
    document.getElementById('imageFile').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Armazena o resultado no campo oculto
                document.getElementById('imageBase64').value = e.target.result;
            };
            reader.readAsDataURL(file); // Inicia a leitura do arquivo
        }
    });

    // MODIFICADO: Envia o formul√°rio e adiciona um novo produto
    document.getElementById('productForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const title = document.getElementById('title').value;
      const price = document.getElementById('price').value;
      // Pega o valor do campo oculto, que agora cont√©m a imagem em Base64
      const image = document.getElementById('imageBase64').value;
      const description = document.getElementById('description').value;
      
      // Verifica se a imagem foi selecionada
      if (!image) {
        showToast('Por favor, selecione uma imagem.', 'warning');
        return;
      }

      const product = { title, price, image, description };

      try {
        const response = await authenticatedFetch('/api/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(product)
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Erro ao adicionar produto');
        }
        showToast('Produto adicionado com sucesso!', 'success');
        document.getElementById('productForm').reset();
        document.getElementById('imageBase64').value = ''; // Limpa o campo oculto
        loadProducts();
      } catch (error) {
        // O erro de sess√£o expirada j√° √© tratado dentro do authenticatedFetch,
        // ent√£o aqui s√≥ precisamos nos preocupar com outros erros.
        if (error.message !== 'Sess√£o expirada') {
          showToast(error.message, 'error');
        }
      }
    });
    
    // Carrega os produtos e exibe-os em lista
    async function loadProducts() {
      try {
        const response = await authenticatedFetch('/api/products');
        const products = await response.json();
        const list = document.getElementById('productList');
        list.innerHTML = '';

        if (products.length === 0) {
          const emptyState = document.createElement('div');
          emptyState.className = 'empty-state';
          emptyState.textContent = 'Nenhum produto cadastrado ainda.';
          list.appendChild(emptyState);
          return;
        }

        products.forEach(product => {
          const item = document.createElement('div');
          item.className = 'product-item';
          item.setAttribute('data-id', product.id);

          // Handle de arrastar
          const dragHandle = document.createElement('div');
          dragHandle.className = 'product-drag-handle';
          dragHandle.textContent = '‚ò∞';

          // Imagem
          const img = document.createElement('img');
          img.className = 'product-image';
          img.src = product.image;
          img.alt = product.title;
          img.onerror = function() { this.style.display = 'none'; };

          // Informa√ß√µes do produto
          const info = document.createElement('div');
          info.className = 'product-info';

          const title = document.createElement('h3');
          title.className = 'product-title';
          title.textContent = product.title;

          const price = document.createElement('p');
          price.className = 'product-price';
          price.textContent = `R$ ${(product.price/100).toFixed(2)}`;

          const desc = document.createElement('p');
          desc.className = 'product-description';
          desc.textContent = product.description || 'Sem descri√ß√£o';

          info.appendChild(title);
          info.appendChild(price);
          info.appendChild(desc);

          // A√ß√µes
          const actions = document.createElement('div');
          actions.className = 'product-actions';

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-button';
          deleteBtn.textContent = '√ó';
          deleteBtn.addEventListener('click', () => deleteProduct(product.id));

          actions.appendChild(deleteBtn);

          // Monta o item
          item.appendChild(dragHandle);
          item.appendChild(img);
          item.appendChild(info);
          item.appendChild(actions);

          list.appendChild(item);
        });

        // Inicializa o Sortable para reordenar os itens
        new Sortable(list, {
          animation: 150,
          handle: '.product-drag-handle',
          ghostClass: 'dragging',
          onEnd: function(evt) {
            const items = list.children;
            const newOrder = Array.from(items)
              .filter(item => item.classList.contains('product-item'))
              .map(item => item.getAttribute('data-id'));

            authenticatedFetch('/api/products/reorder', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ order: newOrder })
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('Falha ao reordenar produtos.');
              }
              return response.json();
            })
            .then(data => {
              showToast('Ordem atualizada com sucesso!', 'success');
            })
            .catch(error => {
              if (error.message !== 'Sess√£o expirada') {
                console.error('Erro ao reordenar:', error);
                showToast('Erro ao salvar a nova ordem.', 'error');
              }
            });
          }
        });
      } catch (error) {
        if (error.message !== 'Sess√£o expirada') {
          console.error('Erro ao carregar produtos:', error);
        }
      }
    }
    
    // Fun√ß√£o para excluir um produto
    // CORRIGIDO: Substitu√≠do alert() por showToast()
    async function deleteProduct(productId) {
      if (!confirm('Tem certeza que deseja excluir este produto?')) return;
      try {
        const response = await authenticatedFetch(`/api/products/${productId}`, {
          method: 'DELETE'
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Erro ao excluir produto');
        }
        showToast('Produto exclu√≠do com sucesso!', 'success');
        loadProducts();
      } catch (error) {
        if (error.message !== 'Sess√£o expirada') {
          showToast(error.message, 'error');
        }
      }
    }
    
    function carregarMesAno() {
      const selectMes = document.getElementById('mes');
      const selectAno = document.getElementById('ano');
      const hoje = new Date();
      const anoAtual = hoje.getFullYear();
      const mesAtual = hoje.getMonth() + 1;

      const meses = [
        "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
      ];
      selectMes.innerHTML = meses.map((m, i) => 
        `<option value="${i + 1}" ${i + 1 === mesAtual ? "selected" : ""}>${m}</option>`
      ).join("");

      selectAno.innerHTML = "";
      for (let ano = 2025; ano <= anoAtual; ano++) {
        selectAno.innerHTML += `<option value="${ano}" ${ano === anoAtual ? "selected" : ""}>${ano}</option>`;
      }
    }

    // Carrega hist√≥rico de compras com mais informa√ß√µes
    async function loadHistory() {
      const nome = document.getElementById('searchNome')?.value.trim() || "";
      const telefone = document.getElementById('searchTelefone')?.value.trim() || "";
      const mes = document.getElementById('mes').value;
      const ano = document.getElementById('ano').value;

      let url = `/api/purchase-history?mes=${mes}&ano=${ano}`;
      if (nome) url += `&nome=${encodeURIComponent(nome)}`;
      if (telefone) url += `&telefone=${encodeURIComponent(telefone)}`;

      try {
        const response = await authenticatedFetch(url);
        const history = await response.json();
        const resultsDiv = document.getElementById('historyResults');
        resultsDiv.innerHTML = '';

        if (history.length === 0) {
          const emptyState = document.createElement('div');
          emptyState.className = 'empty-state';
          emptyState.textContent = 'Nenhum registro encontrado para os filtros selecionados.';
          resultsDiv.appendChild(emptyState);
          return;
        }

        // Wrapper para scroll horizontal
        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-wrapper';

        // Cria tabela
        const table = document.createElement('table');

        // Cabe√ßalho da tabela
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        ['Nome', 'Telefone', 'Data/Hora', 'Status', 'Transaction ID'].forEach(headerText => {
          const th = document.createElement('th');
          th.textContent = headerText;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Corpo da tabela
        const tbody = document.createElement('tbody');
        history.forEach(item => {
          const row = document.createElement('tr');

          // Nome
          const nomeCell = document.createElement('td');
          nomeCell.textContent = item.nome;
          row.appendChild(nomeCell);

          // Telefone
          const telefoneCell = document.createElement('td');
          telefoneCell.textContent = formatPhone(item.telefone);
          row.appendChild(telefoneCell);

          // Data/Hora
          const dataCell = document.createElement('td');
          dataCell.textContent = new Date(item.dataTransacao).toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          row.appendChild(dataCell);

          // Status com badge
          const statusCell = document.createElement('td');
          const statusBadge = document.createElement('span');
          statusBadge.className = 'status-badge';
          statusBadge.textContent = item.status;

          // Adiciona classe espec√≠fica do status
          const statusMap = {
            'Sucesso': 'status-sucesso',
            'Gerado': 'status-gerado',
            'Falhou': 'status-falhou',
            'Expirado': 'status-expirado'
          };
          statusBadge.classList.add(statusMap[item.status] || 'status-gerado');
          statusCell.appendChild(statusBadge);
          row.appendChild(statusCell);

          // Transaction ID
          const transactionCell = document.createElement('td');
          if (item.transactionId) {
            const transactionSpan = document.createElement('span');
            transactionSpan.className = 'transaction-id';
            transactionSpan.textContent = item.transactionId;
            transactionCell.appendChild(transactionSpan);
          } else {
            transactionCell.textContent = '-';
          }
          row.appendChild(transactionCell);

          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        tableWrapper.appendChild(table);
        resultsDiv.appendChild(tableWrapper);
      } catch (error) {
        if (error.message !== 'Sess√£o expirada') {
          if (typeof console !== 'undefined' && console.error) {
            console.error('Erro ao carregar hist√≥rico:', error);
          }
          showToast('Erro ao carregar hist√≥rico', 'error');
        }
      }
    }

    function formatPhone(value) {
      value = value.replace(/\D/g, "");
      if (value.length > 0) value = "(" + value;
      if (value.length > 3) value = value.slice(0, 3) + ") " + value.slice(3);
      if (value.length > 10) value = value.slice(0, 10) + "-" + value.slice(10);
      return value;
    }

    document.getElementById('searchButton').addEventListener('click', loadHistory);

    // Funcionalidade de Collapse para se√ß√£o de produtos
    function initializeCollapse() {
      const collapseHeader = document.getElementById('productsCollapseHeader');
      const collapseContent = document.getElementById('productsCollapseContent');
      const collapseToggle = document.getElementById('productsToggle');

      collapseHeader.addEventListener('click', () => {
        const isOpen = collapseContent.classList.contains('open');

        if (isOpen) {
          collapseContent.classList.remove('open');
          collapseToggle.classList.remove('open');
        } else {
          collapseContent.classList.add('open');
          collapseToggle.classList.add('open');
        }
      });
    }

    window.onload = () => {
      initializeCollapse();
      loadProducts();
      carregarMesAno();
      loadHistory();
    };

    

  
    // NOVO: C√≥digo para inicializar o Firebase e gerenciar notifica√ß√µes

    
       // CORRE√á√ÉO: Service Worker registration global para passar ao Firebase
    let swRegistration = null;

    // NOVO: Script para registrar o Service Worker
    // CORRE√á√ÉO: Espera o Service Worker estar pronto antes de usar
    async function registerServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        console.warn('Service Worker n√£o suportado neste navegador');
        return null;
      }

      try {
        // Registra o Service Worker
        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        console.log('Service Worker registrado:', registration);

        // CR√çTICO: Aguarda Service Worker estar pronto
        await navigator.serviceWorker.ready;
        console.log('Service Worker est√° ativo e pronto');

        return registration;

      } catch (error) {
        console.error('Falha ao registrar Service Worker:', error);
        return null;
      }
    }

    // CORRIGIDO: Busca configura√ß√£o do Firebase do backend ao inv√©s de hardcoded
    let messaging;

    async function initializeFirebase() {
      try {
        // CORRE√á√ÉO: Registra e aguarda Service Worker ANTES de inicializar Firebase
        swRegistration = await registerServiceWorker();

        if (!swRegistration) {
          throw new Error('Service Worker n√£o p√¥de ser registrado');
        }

        const response = await fetch('/api/firebase-config');
        if (!response.ok) {
          throw new Error('Erro ao buscar configura√ß√£o do Firebase');
        }
        const config = await response.json();

        // Remove vapidKey do config principal
        const { vapidKey, ...firebaseConfig } = config;

        firebase.initializeApp(firebaseConfig);
        if (typeof console !== 'undefined' && console.log) {
          console.log('[Firebase JS] SDK do Firebase inicializado.');
        }

        messaging = firebase.messaging();

        // Escuta por notifica√ß√µes recebidas em primeiro plano
        messaging.onMessage((payload) => {
          if (typeof console !== 'undefined' && console.log) {
            console.log('[Firebase JS] MENSAGEM RECEBIDA EM PRIMEIRO PLANO: ', payload);
          }
          // Mostra toast ao inv√©s de alert
          showToast(
            `${payload.notification.title}: ${payload.notification.body}`,
            'success'
          );
        });

        return vapidKey;
      } catch (error) {
        if (typeof console !== 'undefined' && console.error) {
          console.error('Erro ao inicializar Firebase:', error);
        }
        showToast('Erro ao inicializar notifica√ß√µes', 'error');
        return null;
      }
    }

    function requestNotificationPermission(vapidKey) {
      if (!vapidKey || !messaging) {
        showToast('Firebase n√£o est√° configurado corretamente', 'error');
        return;
      }

      // CORRE√á√ÉO: Valida que Service Worker est√° pronto
      if (!swRegistration) {
        showToast('Service Worker n√£o est√° pronto. Recarregue a p√°gina.', 'error');
        return;
      }

      if (typeof console !== 'undefined' && console.log) {
        console.log('Solicitando permiss√£o para notifica√ß√µes...');
      }

      Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
          if (typeof console !== 'undefined' && console.log) {
            console.log('Permiss√£o para notifica√ß√£o concedida.');
          }

          // CORRE√á√ÉO: Passa Service Worker registration para getToken
          messaging.getToken({
            vapidKey: vapidKey,
            serviceWorkerRegistration: swRegistration
          }).then((currentToken) => {
            if (currentToken) {
              if (typeof console !== 'undefined' && console.log) {
                console.log('[Firebase JS] Token obtido:', currentToken);
              }
              sendTokenToServer(currentToken);
              showToast('Notifica√ß√µes ativadas com sucesso!', 'success');
            } else {
              if (typeof console !== 'undefined' && console.error) {
                console.error('[Firebase JS] N√£o foi poss√≠vel obter o token.');
              }
              showToast('Erro ao obter token de notifica√ß√£o', 'error');
            }
          }).catch((err) => {
            if (typeof console !== 'undefined' && console.error) {
              console.error('[Firebase JS] Erro ao obter token:', err);
            }
            showToast('Erro ao configurar notifica√ß√µes: ' + err.message, 'error');
          });

        } else {
          if (typeof console !== 'undefined' && console.warn) {
            console.warn('[Firebase JS] Permiss√£o negada.');
          }
          showToast('Permiss√£o para notifica√ß√µes negada', 'warning');
        }
      });
    }

    // Fun√ß√£o para enviar o token para o seu backend
    // MODIFICADO: Fun√ß√£o para enviar o token para o seu backend agora usa authenticatedFetch
    async function sendTokenToServer(token) {
      try {
        const response = await authenticatedFetch('/api/devices', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ token: token }),
        });
        const data = await response.json();
        console.log('Resposta do servidor ao registrar dispositivo:', data);
      } catch (err) {
        if (err.message !== 'Sess√£o expirada') {
          console.error('Erro ao enviar token para o servidor:', err);
        }
      }
    }

    // CORRIGIDO: Inicializa Firebase e configura bot√£o de notifica√ß√µes
    let firebaseVapidKey = null;

    // Inicializa Firebase quando a p√°gina carregar
    initializeFirebase().then(vapidKey => {
      firebaseVapidKey = vapidKey;

      // Adiciona um bot√£o para o admin ativar as notifica√ß√µes
      const notificationButton = document.createElement('button');
      notificationButton.className = 'notification-button';
      notificationButton.textContent = 'üîî Ativar Notifica√ß√µes de Venda';
      notificationButton.onclick = () => requestNotificationPermission(firebaseVapidKey);
      // Insere o bot√£o ap√≥s o header
      const adminHeader = document.querySelector('.admin-header');
      adminHeader.insertAdjacentElement('afterend', notificationButton);
    });
    
  

  </script>
</body>
</html>