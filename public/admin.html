<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.jsdelivr.net https://firebaseinstallations.googleapis.com https://fcmregistrations.googleapis.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://www.gstatic.com https://firebaseinstallations.googleapis.com https://fcmregistrations.googleapis.com https://fcm.googleapis.com; font-src 'self' data:;">
  <title>Admin - Produtos</title>
  <style>
    /* Reset e Estilos Gerais */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    /* Header */
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    h1 {
      margin: 0;
      color: #2c3e50;
      font-size: 2rem;
      font-weight: 600;
    }

    .logout-link {
      padding: 10px 20px;
      background: #e74c3c;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .logout-link:hover {
      background: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
    }

    /* Se√ß√µes */
    .section {
      margin-bottom: 40px;
    }

    .section-title {
      color: #2c3e50;
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 2px;
    }

    /* Formul√°rio */
    .form-card {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
    }

    .form-grid {
      display: grid;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    input[type="file"] {
      padding: 8px;
      cursor: pointer;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    button {
      padding: 14px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    .button-secondary {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    }

    .button-secondary:hover {
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }

    .button-warning {
      background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    }

    .button-warning:hover {
      box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
    }

    /* Se√ß√£o Colaps√°vel */
    .collapsible-section {
      margin-bottom: 30px;
    }

    .collapse-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 15px 20px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
      user-select: none;
    }

    .collapse-header:hover {
      background: #e9ecef;
      border-color: #667eea;
    }

    .collapse-header h2 {
      margin: 0;
      color: #2c3e50;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .collapse-toggle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      transition: transform 0.3s ease;
    }

    .collapse-toggle.open {
      transform: rotate(180deg);
    }

    .collapse-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .collapse-content.open {
      max-height: 5000px;
      padding-top: 20px;
    }

    /* Lista de Produtos */
    .product-list {
      background: #f8f9fa;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      overflow: hidden;
    }

    .product-item {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 15px 20px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      transition: all 0.2s ease;
      cursor: move;
    }

    .product-item:last-child {
      border-bottom: none;
    }

    .product-item:hover {
      background: #f8f9fa;
      transform: translateX(5px);
    }

    .product-item.dragging {
      opacity: 0.5;
      background: #e9ecef;
    }

    .product-drag-handle {
      color: #95a5a6;
      font-size: 20px;
      cursor: grab;
    }

    .product-drag-handle:active {
      cursor: grabbing;
    }

    .product-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
    }

    .product-info {
      flex: 1;
      min-width: 0;
    }

    .product-title {
      font-weight: 600;
      color: #2c3e50;
      margin: 0 0 5px 0;
      font-size: 1.1rem;
    }

    .product-price {
      color: #27ae60;
      font-weight: 600;
      font-size: 1.1rem;
      margin: 0 0 5px 0;
    }

    .product-description {
      color: #7f8c8d;
      font-size: 0.9rem;
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-actions {
      display: flex;
      gap: 10px;
    }

    .delete-button {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-button:hover {
      background: #c0392b;
      transform: scale(1.1);
    }

    .empty-state {
      padding: 40px;
      text-align: center;
      color: #95a5a6;
      font-size: 1.1rem;
    }

    /* Filtros de Hist√≥rico */
    .history-filters {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      margin-bottom: 20px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    #searchButton {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* Tabela de Hist√≥rico */
    .table-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      background: white;
    }

    #historyResults table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    #historyResults th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      padding: 15px;
      text-align: left;
      white-space: nowrap;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #historyResults td {
      padding: 12px 15px;
      border-bottom: 1px solid #e0e0e0;
      color: #2c3e50;
    }

    #historyResults tr:last-child td {
      border-bottom: none;
    }

    #historyResults tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-sucesso {
      background: #d4edda;
      color: #155724;
    }

    .status-gerado {
      background: #fff3cd;
      color: #856404;
    }

    .status-falhou {
      background: #f8d7da;
      color: #721c24;
    }

    .status-expirado {
      background: #e2e3e5;
      color: #383d41;
    }

    .transaction-id {
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      color: #6c757d;
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.3);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
      max-width: 400px;
      font-weight: 500;
    }

    .toast.show {
      opacity: 1;
    }

    .toast.success {
      background: linear-gradient(135deg, #28a745, #20c997);
    }

    .toast.error {
      background: linear-gradient(135deg, #dc3545, #c82333);
    }

    .toast.warning {
      background: linear-gradient(135deg, #ffc107, #ff9800);
    }

    /* Bot√£o de Notifica√ß√µes */
    .notification-button {
      background: linear-gradient(135deg, #28a745, #20c997);
      margin-bottom: 20px;
    }

    .notification-button:hover {
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    /* Dashboard de Estat√≠sticas */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      border-color: #667eea;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card.success::before {
      background: linear-gradient(135deg, #28a745, #20c997);
    }

    .stat-card.warning::before {
      background: linear-gradient(135deg, #ffc107, #ff9800);
    }

    .stat-card.info::before {
      background: linear-gradient(135deg, #17a2b8, #138496);
    }

    .stat-icon {
      font-size: 2rem;
      margin-bottom: 10px;
      opacity: 0.8;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #7f8c8d;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .stat-subtitle {
      font-size: 0.85rem;
      color: #95a5a6;
    }

    .stat-change {
      font-size: 0.85rem;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-top: 8px;
    }

    .stat-change.positive {
      color: #27ae60;
      background: #d4edda;
    }

    .stat-change.negative {
      color: #c0392b;
      background: #f8d7da;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Pagina√ß√£o */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .pagination-button {
      padding: 8px 16px;
      background: #f8f9fa;
      color: #2c3e50;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      width: auto;
      min-width: 40px;
    }

    .pagination-button:hover:not(:disabled) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }

    .pagination-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }

    .pagination-info {
      color: #7f8c8d;
      font-size: 0.9rem;
      padding: 0 10px;
    }

    /* Bot√£o de Atualizar Status */
    .update-status-btn {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: auto;
    }

    .update-status-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
    }

    .update-status-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Configura√ß√µes de Pagamento */
    .payment-settings-container {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
    }

    .gateway-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .gateway-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .gateway-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .gateway-card.active {
      border-color: #28a745;
      background: linear-gradient(to bottom, #d4edda 0%, white 100%);
    }

    .gateway-card.active::before {
      content: '‚úì ATIVO';
      position: absolute;
      top: 10px;
      right: 10px;
      background: #28a745;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .gateway-card {
      position: relative;
    }

    .gateway-card.not-configured {
      opacity: 0.6;
      border-color: #dc3545;
    }

    .gateway-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }

    .gateway-icon {
      font-size: 2rem;
    }

    .gateway-header h3 {
      margin: 0;
      color: #2c3e50;
      font-size: 1.25rem;
    }

    .gateway-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
      font-size: 0.9rem;
      color: #6c757d;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-indicator.configured {
      background: #28a745;
    }

    .status-indicator.not-configured {
      background: #dc3545;
    }

    .status-indicator.loading {
      background: #ffc107;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .gateway-actions {
      display: flex;
      gap: 10px;
    }

    .gateway-select-btn {
      flex: 1;
      padding: 10px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .gateway-select-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .gateway-select-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .gateway-test-btn {
      padding: 10px 16px;
      background: #f8f9fa;
      color: #495057;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .gateway-test-btn:hover {
      background: #e9ecef;
      border-color: #667eea;
    }

    .current-gateway-info {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      border: 2px solid #28a745;
      text-align: center;
      font-size: 1.1rem;
    }

    .current-gateway-info strong {
      color: #2c3e50;
    }

    #activeGatewayName {
      color: #28a745;
      font-weight: 600;
      text-transform: uppercase;
    }

    /* Responsividade */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 20px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .admin-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .logout-link {
        width: 100%;
        text-align: center;
      }

      .section-title {
        font-size: 1.25rem;
      }

      .filter-grid {
        grid-template-columns: 1fr;
      }

      .product-item {
        flex-wrap: wrap;
      }

      .product-info {
        flex: 1 1 100%;
        order: 3;
      }

      .product-image {
        width: 50px;
        height: 50px;
      }

      #historyResults {
        font-size: 0.9rem;
      }

      #historyResults th,
      #historyResults td {
        padding: 10px 8px;
      }

      .toast {
        left: 10px;
        right: 10px;
        max-width: none;
      }
    }

    @media (max-width: 480px) {
      .product-drag-handle {
        display: none;
      }

      .product-item {
        padding: 12px 15px;
      }

      #historyResults table {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="admin-header">
      <h1>üé¨ Painel de Administra√ß√£o</h1>
      <a href="/logout" class="logout-link">Sair</a>
    </div>

    <!-- Dashboard de Estat√≠sticas -->
    <div class="section" id="dashboardSection" style="display: none;">
      <h2 class="section-title">üìà Dashboard</h2>
      <div class="stats-grid" id="statsGrid">
        <!-- Cards de estat√≠sticas ser√£o inseridos aqui via JavaScript -->
      </div>
    </div>

    <!-- Se√ß√£o: Configura√ß√µes de Pagamento (Colaps√°vel) -->
    <div class="collapsible-section">
      <div class="collapse-header" id="paymentCollapseHeader">
        <h2>üí≥ Configura√ß√µes de Pagamento</h2>
        <div class="collapse-toggle" id="paymentToggle">‚ñº</div>
      </div>
      <div class="collapse-content" id="paymentCollapseContent">
        <div class="section">
          <div class="payment-settings-container">
            <p style="color: #7f8c8d; margin-bottom: 20px;">Selecione o gateway de pagamento que ser√° usado para processar os pagamentos PIX.</p>

            <div class="gateway-grid" id="gatewayGrid">
              <!-- Gateway OndaPay -->
              <div class="gateway-card" id="gatewayOndapay" data-gateway="ondapay">
                <div class="gateway-header">
                  <span class="gateway-icon">üåä</span>
                  <h3>OndaPay</h3>
                </div>
                <div class="gateway-status" id="ondapayStatus">
                  <span class="status-indicator loading"></span>
                  <span>Verificando...</span>
                </div>
                <div class="gateway-actions">
                  <button class="gateway-select-btn" onclick="selectGateway('ondapay')">Selecionar</button>
                  <button class="gateway-test-btn" onclick="testGateway('ondapay')">Testar</button>
                </div>
              </div>

              <!-- Gateway AbacatePay -->
              <div class="gateway-card" id="gatewayAbacatepay" data-gateway="abacatepay">
                <div class="gateway-header">
                  <span class="gateway-icon">ü•ë</span>
                  <h3>AbacatePay</h3>
                </div>
                <div class="gateway-status" id="abacatepayStatus">
                  <span class="status-indicator loading"></span>
                  <span>Verificando...</span>
                </div>
                <div class="gateway-actions">
                  <button class="gateway-select-btn" onclick="selectGateway('abacatepay')">Selecionar</button>
                  <button class="gateway-test-btn" onclick="testGateway('abacatepay')">Testar</button>
                </div>
              </div>
            </div>

            <div class="current-gateway-info" id="currentGatewayInfo">
              <strong>Gateway Ativo:</strong> <span id="activeGatewayName">Carregando...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Se√ß√£o: Adicionar Produto (Colaps√°vel) -->
    <div class="collapsible-section">
      <div class="collapse-header" id="addProductCollapseHeader">
        <h2>‚ûï Adicionar Novo Produto</h2>
        <div class="collapse-toggle" id="addProductToggle">‚ñº</div>
      </div>
      <div class="collapse-content" id="addProductCollapseContent">
        <div class="section">
          <div class="form-card">
            <form id="productForm" class="form-grid">
              <div class="form-group">
                <label for="title">T√≠tulo do Produto</label>
                <input type="text" id="title" placeholder="Ex: Ingresso Cinema Premium" required>
              </div>

              <div class="form-group">
                <label for="price">Pre√ßo (em centavos)</label>
                <input type="number" id="price" placeholder="Ex: 2500 = R$ 25,00" required>
              </div>

              <div class="form-group">
                <label for="imageFile">Imagem do Produto</label>
                <input type="file" id="imageFile" accept="image/*" required>
                <input type="hidden" id="imageBase64">
              </div>

              <div class="form-group">
                <label for="description">Descri√ß√£o</label>
                <textarea id="description" placeholder="Descreva os detalhes do produto..."></textarea>
              </div>

              <button type="submit">‚ûï Adicionar Produto</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Se√ß√£o: Produtos Existentes (Colaps√°vel) -->
    <div class="collapsible-section">
      <div class="collapse-header" id="productsCollapseHeader">
        <h2>üì¶ Produtos Existentes</h2>
        <div class="collapse-toggle" id="productsToggle">‚ñº</div>
      </div>
      <div class="collapse-content" id="productsCollapseContent">
        <div class="product-list" id="productList"></div>
      </div>
    </div>

    <!-- Se√ß√£o: Hist√≥rico de Compras -->
    <div class="section">
      <h2 class="section-title">üìä Hist√≥rico de Compras</h2>

      <div class="history-filters">
        <div class="filter-grid">
          <div class="form-group">
            <label for="searchNome">Nome do Cliente</label>
            <input type="text" id="searchNome" placeholder="Buscar por nome...">
          </div>

          <div class="form-group">
            <label for="searchTelefone">Telefone</label>
            <input type="text" id="searchTelefone" placeholder="(00) 00000-0000">
          </div>

          <div class="form-group">
            <label for="searchTransactionId">Transaction ID</label>
            <input type="text" id="searchTransactionId" placeholder="ID da transa√ß√£o...">
          </div>

          <div class="form-group">
            <label for="searchStatus">Status</label>
            <select id="searchStatus">
              <option value="">Todos</option>
              <option value="Gerado">Gerado</option>
              <option value="Sucesso">Sucesso</option>
              <option value="Falhou">Falhou</option>
              <option value="Expirado">Expirado</option>
            </select>
          </div>

          <div class="form-group">
            <label for="dataInicio">Data In√≠cio</label>
            <input type="date" id="dataInicio">
          </div>

          <div class="form-group">
            <label for="dataFim">Data Fim</label>
            <input type="date" id="dataFim">
          </div>

          <div class="form-group">
            <label for="mes">M√™s (ou use datas acima)</label>
            <select id="mes"></select>
          </div>

          <div class="form-group">
            <label for="ano">Ano</label>
            <select id="ano"></select>
          </div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
          <button id="searchButton">üîç Buscar</button>
          <button id="refreshButton" class="button-secondary">üîÑ Atualizar Todos</button>
          <button id="archiveButton" class="button-warning">üì¶ Arquivar Pendentes</button>
        </div>
      </div>

      <div id="historyResults"></div>
    </div>
  </div>

  <!--
    SEGURAN√áA: Scripts CDN com Subresource Integrity (SRI)

    Para gerar os hashes SRI, execute: node generate-sri.js
    Ou use: https://www.srihash.org/

    Adicione integrity="sha384-HASH_AQUI" quando tiver os hashes.
    O atributo crossorigin="anonymous" j√° est√° configurado.
  -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js" crossorigin="anonymous"></script>
  <script>
    // CSRF Token cache
    let csrfToken = null;

    // Fun√ß√£o para obter CSRF token
    async function getCsrfToken() {
      if (!csrfToken) {
        try {
          const response = await fetch('/api/csrf-token');
          if (!response.ok) {
            throw new Error('Erro ao obter CSRF token');
          }
          const data = await response.json();
          csrfToken = data.csrfToken;
        } catch (error) {
          console.error('Erro ao obter CSRF token:', error);
          throw error;
        }
      }
      return csrfToken;
    }

    // NOVO: Fun√ß√£o para exibir toast notifications
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      // For√ßa reflow para aplicar transi√ß√£o
      void toast.offsetWidth;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            document.body.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // MODIFICADO: Fun√ß√£o centralizada para fazer chamadas de API com CSRF e tratamento de sess√£o expirada
        async function authenticatedFetch(url, options = {}) {
            try {
                // Adiciona CSRF token em requisi√ß√µes que modificam dados (POST, PUT, DELETE)
                const method = options.method ? options.method.toUpperCase() : 'GET';
                if (['POST', 'PUT', 'DELETE'].includes(method)) {
                    const token = await getCsrfToken();
                    options.headers = {
                        ...options.headers,
                        'CSRF-Token': token
                    };
                }

                const response = await fetch(url, options);

                // Se a resposta for 403 e for um m√©todo que requer CSRF, tenta novamente com novo token
                if (response.status === 403 && ['POST', 'PUT', 'DELETE'].includes(method)) {
                    csrfToken = null; // Limpa token antigo
                    const newToken = await getCsrfToken();
                    options.headers = {
                        ...options.headers,
                        'CSRF-Token': newToken
                    };

                    const retryResponse = await fetch(url, options);

                    // Se ainda der 403, pode ser outro problema
                    if (retryResponse.status === 403) {
                        showToast('Erro de autentica√ß√£o. Recarregue a p√°gina.', 'error');
                        throw new Error('CSRF validation failed');
                    }

                    // Se agora for 401, sess√£o expirada
                    if (retryResponse.status === 401) {
                        const data = await retryResponse.json();
                        showToast(data.error || 'Sua sess√£o expirou, fa√ßa o login novamente.', 'error');
                        setTimeout(() => {
                          window.location.href = '/login';
                        }, 1500);
                        throw new Error('Sess√£o expirada');
                    }

                    return retryResponse;
                }

                // Se a resposta for 401 (N√£o Autorizado), a sess√£o expirou
                if (response.status === 401) {
                    const data = await response.json();
                    showToast(data.error || 'Sua sess√£o expirou, fa√ßa o login novamente.', 'error');
                    // Redireciona para a p√°gina de login
                    setTimeout(() => {
                      window.location.href = '/login';
                    }, 1500);
                    // Lan√ßa um erro para parar a execu√ß√£o do c√≥digo que chamou esta fun√ß√£o
                    throw new Error('Sess√£o expirada');
                }

                return response; // Se n√£o houver erro, retorna a resposta original
            } catch (error) {
                // Se o erro j√° for de sess√£o expirada, apenas o propaga
                if (error.message === 'Sess√£o expirada') {
                    throw error;
                }
                // Para outros erros de rede, etc.
                if (typeof console !== 'undefined' && console.error) {
                  console.error('Erro na chamada da API:', error);
                }
                showToast('Ocorreu um erro de comunica√ß√£o com o servidor.', 'error');
                throw error;
            }
        }


    // NOVO: Listener para converter a imagem selecionada para Base64
    document.getElementById('imageFile').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Armazena o resultado no campo oculto
                document.getElementById('imageBase64').value = e.target.result;
            };
            reader.readAsDataURL(file); // Inicia a leitura do arquivo
        }
    });

    // MODIFICADO: Envia o formul√°rio e adiciona um novo produto
    document.getElementById('productForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const title = document.getElementById('title').value;
      const price = document.getElementById('price').value;
      // Pega o valor do campo oculto, que agora cont√©m a imagem em Base64
      const image = document.getElementById('imageBase64').value;
      const description = document.getElementById('description').value;
      
      // Verifica se a imagem foi selecionada
      if (!image) {
        showToast('Por favor, selecione uma imagem.', 'warning');
        return;
      }

      const product = { title, price, image, description };

      try {
        const response = await authenticatedFetch('/api/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(product)
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Erro ao adicionar produto');
        }
        showToast('Produto adicionado com sucesso!', 'success');
        document.getElementById('productForm').reset();
        document.getElementById('imageBase64').value = ''; // Limpa o campo oculto
        loadProducts();
      } catch (error) {
        // O erro de sess√£o expirada j√° √© tratado dentro do authenticatedFetch,
        // ent√£o aqui s√≥ precisamos nos preocupar com outros erros.
        if (error.message !== 'Sess√£o expirada') {
          showToast(error.message, 'error');
        }
      }
    });
    
    // Carrega os produtos e exibe-os em lista
    async function loadProducts() {
      try {
        const response = await authenticatedFetch('/api/products');
        const products = await response.json();
        const list = document.getElementById('productList');
        list.innerHTML = '';

        if (products.length === 0) {
          const emptyState = document.createElement('div');
          emptyState.className = 'empty-state';
          emptyState.textContent = 'Nenhum produto cadastrado ainda.';
          list.appendChild(emptyState);
          return;
        }

        products.forEach(product => {
          const item = document.createElement('div');
          item.className = 'product-item';
          item.setAttribute('data-id', product.id);

          // Handle de arrastar
          const dragHandle = document.createElement('div');
          dragHandle.className = 'product-drag-handle';
          dragHandle.textContent = '‚ò∞';

          // Imagem
          const img = document.createElement('img');
          img.className = 'product-image';
          img.src = product.image;
          img.alt = product.title;
          img.onerror = function() { this.style.display = 'none'; };

          // Informa√ß√µes do produto
          const info = document.createElement('div');
          info.className = 'product-info';

          const title = document.createElement('h3');
          title.className = 'product-title';
          title.textContent = product.title;

          const price = document.createElement('p');
          price.className = 'product-price';
          price.textContent = `R$ ${(product.price/100).toFixed(2)}`;

          const desc = document.createElement('p');
          desc.className = 'product-description';
          desc.textContent = product.description || 'Sem descri√ß√£o';

          info.appendChild(title);
          info.appendChild(price);
          info.appendChild(desc);

          // A√ß√µes
          const actions = document.createElement('div');
          actions.className = 'product-actions';

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-button';
          deleteBtn.textContent = '√ó';
          deleteBtn.addEventListener('click', () => deleteProduct(product.id));

          actions.appendChild(deleteBtn);

          // Monta o item
          item.appendChild(dragHandle);
          item.appendChild(img);
          item.appendChild(info);
          item.appendChild(actions);

          list.appendChild(item);
        });

        // Inicializa o Sortable para reordenar os itens
        new Sortable(list, {
          animation: 150,
          handle: '.product-drag-handle',
          ghostClass: 'dragging',
          onEnd: function(evt) {
            const items = list.children;
            const newOrder = Array.from(items)
              .filter(item => item.classList.contains('product-item'))
              .map(item => item.getAttribute('data-id'));

            authenticatedFetch('/api/products/reorder', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ order: newOrder })
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('Falha ao reordenar produtos.');
              }
              return response.json();
            })
            .then(data => {
              showToast('Ordem atualizada com sucesso!', 'success');
            })
            .catch(error => {
              if (error.message !== 'Sess√£o expirada') {
                console.error('Erro ao reordenar:', error);
                showToast('Erro ao salvar a nova ordem.', 'error');
              }
            });
          }
        });
      } catch (error) {
        if (error.message !== 'Sess√£o expirada') {
          console.error('Erro ao carregar produtos:', error);
        }
      }
    }
    
    // Fun√ß√£o para excluir um produto
    // CORRIGIDO: Substitu√≠do alert() por showToast()
    async function deleteProduct(productId) {
      if (!confirm('Tem certeza que deseja excluir este produto?')) return;
      try {
        const response = await authenticatedFetch(`/api/products/${productId}`, {
          method: 'DELETE'
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Erro ao excluir produto');
        }
        showToast('Produto exclu√≠do com sucesso!', 'success');
        loadProducts();
      } catch (error) {
        if (error.message !== 'Sess√£o expirada') {
          showToast(error.message, 'error');
        }
      }
    }
    
    function carregarMesAno() {
      const selectMes = document.getElementById('mes');
      const selectAno = document.getElementById('ano');
      const hoje = new Date();
      const anoAtual = hoje.getFullYear();
      const mesAtual = hoje.getMonth() + 1;

      const meses = [
        "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
      ];

      // Adiciona op√ß√£o "Todos" + meses
      selectMes.innerHTML = '<option value="">Todos</option>' +
        meses.map((m, i) =>
          `<option value="${i + 1}" ${i + 1 === mesAtual ? "selected" : ""}>${m}</option>`
        ).join("");

      // Adiciona op√ß√£o "Todos" + anos
      selectAno.innerHTML = '<option value="">Todos</option>';
      for (let ano = 2025; ano <= anoAtual; ano++) {
        selectAno.innerHTML += `<option value="${ano}" ${ano === anoAtual ? "selected" : ""}>${ano}</option>`;
      }
    }

    // Vari√°vel global para pagina√ß√£o
    let currentPage = 1;
    const itemsPerPage = 10;

    // Carrega hist√≥rico de compras com mais informa√ß√µes
    async function loadHistory(page = 1) {
      currentPage = page;

      const nome = document.getElementById('searchNome')?.value.trim() || "";
      const telefone = document.getElementById('searchTelefone')?.value.trim() || "";
      const transactionId = document.getElementById('searchTransactionId')?.value.trim() || "";
      const status = document.getElementById('searchStatus')?.value || "";
      const dataInicio = document.getElementById('dataInicio')?.value || "";
      const dataFim = document.getElementById('dataFim')?.value || "";
      const mes = document.getElementById('mes')?.value || "";
      const ano = document.getElementById('ano')?.value || "";

      let url = `/api/purchase-history?page=${page}&limit=${itemsPerPage}`;
      if (nome) url += `&nome=${encodeURIComponent(nome)}`;
      if (telefone) url += `&telefone=${encodeURIComponent(telefone)}`;
      if (transactionId) url += `&transactionId=${encodeURIComponent(transactionId)}`;
      if (status) url += `&status=${encodeURIComponent(status)}`;

      // Prioriza range de datas personalizado
      if (dataInicio && dataFim) {
        url += `&dataInicio=${dataInicio}&dataFim=${dataFim}`;
      } else if (mes && ano) {
        url += `&mes=${mes}&ano=${ano}`;
      }

      try {
        const response = await authenticatedFetch(url);
        const result = await response.json();
        const history = result.data || [];
        const pagination = result.pagination || {};
        const resultsDiv = document.getElementById('historyResults');
        resultsDiv.innerHTML = '';

        if (history.length === 0) {
          const emptyState = document.createElement('div');
          emptyState.className = 'empty-state';
          emptyState.textContent = 'Nenhum registro encontrado para os filtros selecionados.';
          resultsDiv.appendChild(emptyState);
          return;
        }

        // Wrapper para scroll horizontal
        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-wrapper';

        // Cria tabela
        const table = document.createElement('table');

        // Cabe√ßalho da tabela
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        ['Nome', 'Telefone', 'Data/Hora', 'Valor', 'Status', 'Transaction ID', 'A√ß√µes'].forEach(headerText => {
          const th = document.createElement('th');
          th.textContent = headerText;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Corpo da tabela
        const tbody = document.createElement('tbody');
        history.forEach(item => {
          const row = document.createElement('tr');

          // Nome
          const nomeCell = document.createElement('td');
          nomeCell.textContent = item.nome;
          row.appendChild(nomeCell);

          // Telefone
          const telefoneCell = document.createElement('td');
          telefoneCell.textContent = formatPhone(item.telefone);
          row.appendChild(telefoneCell);

          // Data/Hora
          const dataCell = document.createElement('td');
          dataCell.textContent = new Date(item.dataTransacao).toLocaleString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          row.appendChild(dataCell);

          // Valor
          const valorCell = document.createElement('td');
          const valorSpan = document.createElement('span');
          valorSpan.style.fontWeight = '600';
          valorSpan.style.color = '#27ae60';
          if (item.valorPago && item.valorPago > 0) {
            valorSpan.textContent = `R$ ${(item.valorPago / 100).toFixed(2)}`;
          } else {
            valorSpan.textContent = '-';
            valorSpan.style.color = '#95a5a6';
          }
          valorCell.appendChild(valorSpan);
          row.appendChild(valorCell);

          // Status com badge
          const statusCell = document.createElement('td');
          const statusBadge = document.createElement('span');
          statusBadge.className = 'status-badge';
          statusBadge.textContent = item.status;

          // Adiciona classe espec√≠fica do status
          const statusMap = {
            'Sucesso': 'status-sucesso',
            'Gerado': 'status-gerado',
            'Falhou': 'status-falhou',
            'Expirado': 'status-expirado'
          };
          statusBadge.classList.add(statusMap[item.status] || 'status-gerado');
          statusCell.appendChild(statusBadge);
          row.appendChild(statusCell);

          // Transaction ID
          const transactionCell = document.createElement('td');
          if (item.transactionId) {
            const transactionSpan = document.createElement('span');
            transactionSpan.className = 'transaction-id';
            transactionSpan.textContent = item.transactionId;
            transactionCell.appendChild(transactionSpan);
          } else {
            transactionCell.textContent = '-';
          }
          row.appendChild(transactionCell);

          // A√ß√µes
          const actionsCell = document.createElement('td');
          if (item.status === 'Gerado' && item.transactionId) {
            const updateBtn = document.createElement('button');
            updateBtn.className = 'update-status-btn';
            updateBtn.textContent = 'üîÑ Atualizar';
            updateBtn.onclick = () => updateTransactionStatus(item.transactionId, item.id);
            actionsCell.appendChild(updateBtn);
          } else {
            actionsCell.textContent = '-';
          }
          row.appendChild(actionsCell);

          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        tableWrapper.appendChild(table);
        resultsDiv.appendChild(tableWrapper);

        // Adiciona pagina√ß√£o
        if (pagination.totalPages > 1) {
          const paginationDiv = createPagination(pagination);
          resultsDiv.appendChild(paginationDiv);
        }
      } catch (error) {
        if (error.message !== 'Sess√£o expirada') {
          if (typeof console !== 'undefined' && console.error) {
            console.error('Erro ao carregar hist√≥rico:', error);
          }
          showToast('Erro ao carregar hist√≥rico', 'error');
        }
      }
    }

    function formatPhone(value) {
      value = value.replace(/\D/g, "");
      if (value.length > 0) value = "(" + value;
      if (value.length > 3) value = value.slice(0, 3) + ") " + value.slice(3);
      if (value.length > 10) value = value.slice(0, 10) + "-" + value.slice(10);
      return value;
    }

    // Cria controles de pagina√ß√£o
    function createPagination(pagination) {
      const paginationDiv = document.createElement('div');
      paginationDiv.className = 'pagination';

      // Bot√£o anterior
      const prevBtn = document.createElement('button');
      prevBtn.className = 'pagination-button';
      prevBtn.textContent = '‚Üê Anterior';
      prevBtn.disabled = pagination.page === 1;
      prevBtn.onclick = () => loadHistory(pagination.page - 1);
      paginationDiv.appendChild(prevBtn);

      // Info da p√°gina
      const pageInfo = document.createElement('span');
      pageInfo.className = 'pagination-info';
      pageInfo.textContent = `P√°gina ${pagination.page} de ${pagination.totalPages} (${pagination.total} registros)`;
      paginationDiv.appendChild(pageInfo);

      // Bot√£o pr√≥ximo
      const nextBtn = document.createElement('button');
      nextBtn.className = 'pagination-button';
      nextBtn.textContent = 'Pr√≥xima ‚Üí';
      nextBtn.disabled = pagination.page === pagination.totalPages;
      nextBtn.onclick = () => loadHistory(pagination.page + 1);
      paginationDiv.appendChild(nextBtn);

      return paginationDiv;
    }

    // Atualiza status de uma transa√ß√£o (atualiza√ß√£o manual)
    async function updateTransactionStatus(transactionId, purchaseId) {
      // Mostra op√ß√µes de status para o admin escolher
      const statusOptions = {
        'Sucesso': '‚úÖ Sucesso (pagamento confirmado)',
        'Falhou': '‚ùå Falhou (pagamento recusado)',
        'Expirado': '‚è±Ô∏è Expirado (tempo de pagamento esgotado)'
      };

      let optionsHtml = 'Escolha o novo status:\n\n';
      Object.keys(statusOptions).forEach((key, index) => {
        optionsHtml += `${index + 1}. ${statusOptions[key]}\n`;
      });

      const choice = prompt(
        `${optionsHtml}\n‚ö†Ô∏è ATEN√á√ÉO: Esta √© uma atualiza√ß√£o MANUAL.\nO webhook da OndaPay √© a forma recomendada de atualizar status.\n\nDigite o n√∫mero da op√ß√£o (1-3):`,
        ''
      );

      if (!choice) return; // Cancelou

      const statusKeys = Object.keys(statusOptions);
      const selectedIndex = parseInt(choice) - 1;

      if (selectedIndex < 0 || selectedIndex >= statusKeys.length) {
        showToast('Op√ß√£o inv√°lida', 'error');
        return;
      }

      const newStatus = statusKeys[selectedIndex];

      // Confirma a a√ß√£o
      if (!confirm(`Confirma atualizar para "${newStatus}"?\n\nTransaction ID: ${transactionId}`)) {
        return;
      }

      try {
        const response = await authenticatedFetch('/api/update-transaction-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transactionId, newStatus })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showToast(result.message, 'success');
          // Recarrega o hist√≥rico para mostrar o novo status
          loadHistory(currentPage);
        } else {
          showToast(result.error || 'Erro ao atualizar status', 'error');
        }
      } catch (error) {
        if (error.message !== 'Sess√£o expirada') {
          console.error('Erro ao atualizar status:', error);
          showToast('Erro ao atualizar status da transa√ß√£o', 'error');
        }
      }
    }

    document.getElementById('searchButton').addEventListener('click', () => loadHistory(1));

    // Funcionalidade de Atualizar Todos - Recarrega dados do banco de dados
    document.getElementById('refreshButton').addEventListener('click', async () => {
      const button = document.getElementById('refreshButton');
      const originalText = button.textContent;

      try {
        // Mostra indicador de loading
        button.textContent = '‚è≥ Atualizando...';
        button.disabled = true;

        // Recarrega os dados do banco de dados
        await loadHistory(currentPage);

        // Mostra feedback de sucesso
        showToast('‚úÖ Dados atualizados com sucesso!', 'success');

      } catch (error) {
        console.error('Erro ao atualizar dados:', error);
        showToast('‚ùå Erro ao atualizar dados', 'error');
      } finally {
        // Restaura o bot√£o
        button.textContent = originalText;
        button.disabled = false;
      }
    });

    // Funcionalidade de Arquivar Pendentes - Muda status "Gerado" para "Expirado"
    document.getElementById('archiveButton').addEventListener('click', async () => {
      const confirmMsg = 'üì¶ Tem certeza que deseja arquivar TODAS as transa√ß√µes pendentes?\n\n' +
                        'Todas as transa√ß√µes com status "Gerado" ser√£o marcadas como "Expirado".\n\n' +
                        'Voc√™ poder√° reverter individualmente usando o bot√£o üîÑ de cada transa√ß√£o.';

      if (!confirm(confirmMsg)) {
        return;
      }

      const button = document.getElementById('archiveButton');
      const originalText = button.textContent;

      try {
        button.textContent = '‚è≥ Arquivando...';
        button.disabled = true;

        // Busca todas as transa√ß√µes com status "Gerado"
        const response = await authenticatedFetch('/api/purchase-history?status=Gerado&limit=1000');
        const data = await response.json();

        if (!data.data || data.data.length === 0) {
          showToast('‚ÑπÔ∏è Nenhuma transa√ß√£o pendente encontrada', 'info');
          return;
        }

        const pendingTransactions = data.data;
        let successCount = 0;
        let errorCount = 0;

        // Atualiza cada transa√ß√£o individualmente
        for (const transaction of pendingTransactions) {
          try {
            const token = await getCsrfToken();
            const updateResponse = await authenticatedFetch('/api/update-transaction-status', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'CSRF-Token': token
              },
              body: JSON.stringify({
                transactionId: transaction.transactionId,
                newStatus: 'Expirado'
              })
            });

            if (updateResponse.ok) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (error) {
            errorCount++;
            console.error(`Erro ao arquivar transa√ß√£o ${transaction.transactionId}:`, error);
          }
        }

        // Mostra resultado
        if (successCount > 0) {
          showToast(`‚úÖ ${successCount} transa√ß√£o(√µes) arquivada(s) com sucesso!`, 'success');
          // Recarrega o hist√≥rico
          await loadHistory(currentPage);
        }

        if (errorCount > 0) {
          showToast(`‚ö†Ô∏è ${errorCount} transa√ß√£o(√µes) n√£o puderam ser arquivadas`, 'warning');
        }

      } catch (error) {
        console.error('Erro ao arquivar transa√ß√µes:', error);
        showToast('‚ùå Erro ao arquivar transa√ß√µes', 'error');
      } finally {
        button.textContent = originalText;
        button.disabled = false;
      }
    });

    // Funcionalidade de Collapse para se√ß√µes colaps√°veis
    function initializeCollapse() {
      // Collapse para "Adicionar Produto"
      const addProductHeader = document.getElementById('addProductCollapseHeader');
      const addProductContent = document.getElementById('addProductCollapseContent');
      const addProductToggle = document.getElementById('addProductToggle');

      addProductHeader.addEventListener('click', () => {
        const isOpen = addProductContent.classList.contains('open');

        if (isOpen) {
          addProductContent.classList.remove('open');
          addProductToggle.classList.remove('open');
        } else {
          addProductContent.classList.add('open');
          addProductToggle.classList.add('open');
        }
      });

      // Collapse para "Produtos Existentes"
      const collapseHeader = document.getElementById('productsCollapseHeader');
      const collapseContent = document.getElementById('productsCollapseContent');
      const collapseToggle = document.getElementById('productsToggle');

      collapseHeader.addEventListener('click', () => {
        const isOpen = collapseContent.classList.contains('open');

        if (isOpen) {
          collapseContent.classList.remove('open');
          collapseToggle.classList.remove('open');
        } else {
          collapseContent.classList.add('open');
          collapseToggle.classList.add('open');
        }
      });

      // Collapse para "Configura√ß√µes de Pagamento"
      const paymentHeader = document.getElementById('paymentCollapseHeader');
      const paymentContent = document.getElementById('paymentCollapseContent');
      const paymentToggle = document.getElementById('paymentToggle');

      if (paymentHeader && paymentContent && paymentToggle) {
        paymentHeader.addEventListener('click', () => {
          const isOpen = paymentContent.classList.contains('open');

          if (isOpen) {
            paymentContent.classList.remove('open');
            paymentToggle.classList.remove('open');
          } else {
            paymentContent.classList.add('open');
            paymentToggle.classList.add('open');
          }
        });
      }
    }

    // --- FUN√á√ïES DE CONFIGURA√á√ÉO DE PAGAMENTO ---

    // Carrega as configura√ß√µes de pagamento
    async function loadPaymentSettings() {
      try {
        const response = await authenticatedFetch('/api/payment-settings');
        const settings = await response.json();

        // Atualiza o nome do gateway ativo
        const activeGatewayName = document.getElementById('activeGatewayName');
        if (activeGatewayName) {
          activeGatewayName.textContent = settings.activeGateway === 'ondapay' ? 'OndaPay üåä' : 'AbacatePay ü•ë';
        }

        // Atualiza cards dos gateways
        updateGatewayCard('ondapay', settings.gateways.ondapay, settings.activeGateway === 'ondapay');
        updateGatewayCard('abacatepay', settings.gateways.abacatepay, settings.activeGateway === 'abacatepay');

      } catch (error) {
        if (error.message !== 'Sess√£o expirada') {
          console.error('Erro ao carregar configura√ß√µes de pagamento:', error);
        }
      }
    }

    // Atualiza o visual de um card de gateway
    function updateGatewayCard(gateway, config, isActive) {
      const card = document.getElementById(`gateway${gateway.charAt(0).toUpperCase() + gateway.slice(1)}`);
      const statusDiv = document.getElementById(`${gateway}Status`);

      if (!card || !statusDiv) return;

      // Remove classes anteriores
      card.classList.remove('active', 'not-configured');

      // Status de configura√ß√£o
      if (config.configured) {
        statusDiv.innerHTML = `<span class="status-indicator configured"></span><span>Configurado</span>`;
      } else {
        statusDiv.innerHTML = `<span class="status-indicator not-configured"></span><span>N√£o configurado</span>`;
        card.classList.add('not-configured');
      }

      // Se √© o gateway ativo
      if (isActive) {
        card.classList.add('active');
      }

      // Desabilita bot√£o de selecionar se n√£o estiver configurado ou se j√° for o ativo
      const selectBtn = card.querySelector('.gateway-select-btn');
      if (selectBtn) {
        selectBtn.disabled = !config.configured || isActive;
        selectBtn.textContent = isActive ? 'Ativo' : 'Selecionar';
      }
    }

    // Seleciona um gateway como ativo
    async function selectGateway(gateway) {
      if (!confirm(`Deseja alterar o gateway de pagamento para ${gateway === 'ondapay' ? 'OndaPay' : 'AbacatePay'}?\n\nNovos pagamentos ser√£o processados pelo gateway selecionado.`)) {
        return;
      }

      try {
        const response = await authenticatedFetch('/api/payment-settings/gateway', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gateway })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showToast(`‚úÖ ${result.message}`, 'success');
          await loadPaymentSettings(); // Recarrega os cards
        } else {
          showToast(`‚ùå ${result.error || 'Erro ao alterar gateway'}`, 'error');
        }
      } catch (error) {
        if (error.message !== 'Sess√£o expirada') {
          console.error('Erro ao selecionar gateway:', error);
          showToast('‚ùå Erro ao alterar gateway de pagamento', 'error');
        }
      }
    }

    // Testa a conex√£o com um gateway
    async function testGateway(gateway) {
      const testBtn = document.querySelector(`#gateway${gateway.charAt(0).toUpperCase() + gateway.slice(1)} .gateway-test-btn`);
      const originalText = testBtn.textContent;

      try {
        testBtn.textContent = '‚è≥ Testando...';
        testBtn.disabled = true;

        const response = await authenticatedFetch('/api/payment-settings/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gateway })
        });

        const result = await response.json();

        if (result.success) {
          showToast(`‚úÖ ${result.message}`, 'success');
        } else {
          showToast(`‚ùå ${result.message}`, 'error');
        }
      } catch (error) {
        if (error.message !== 'Sess√£o expirada') {
          console.error('Erro ao testar gateway:', error);
          showToast('‚ùå Erro ao testar conex√£o com gateway', 'error');
        }
      } finally {
        testBtn.textContent = originalText;
        testBtn.disabled = false;
      }
    }

    // --- FIM DAS FUN√á√ïES DE CONFIGURA√á√ÉO DE PAGAMENTO ---

    // Carrega estat√≠sticas do dashboard
    async function loadStatistics() {
      try {
        const response = await authenticatedFetch('/api/statistics');
        const stats = await response.json();

        const statsGrid = document.getElementById('statsGrid');
        const dashboardSection = document.getElementById('dashboardSection');
        statsGrid.innerHTML = '';

        // Card: Receita do M√™s Atual
        const currentMonthCard = createStatCard({
          icon: 'üí∞',
          label: 'Receita deste M√™s',
          value: `R$ ${(stats.currentMonth.revenue / 100).toFixed(2)}`,
          subtitle: `${stats.currentMonth.sales} vendas`,
          type: 'success',
          change: calculatePercentChange(stats.lastMonth.revenue, stats.currentMonth.revenue)
        });
        statsGrid.appendChild(currentMonthCard);

        // Card: Vendas de Hoje
        const todayCard = createStatCard({
          icon: 'üìÖ',
          label: 'Vendas Hoje',
          value: stats.today.sales,
          subtitle: 'transa√ß√µes conclu√≠das',
          type: 'info'
        });
        statsGrid.appendChild(todayCard);

        // Card: Total Geral
        const totalCard = createStatCard({
          icon: 'üéØ',
          label: 'Receita Total',
          value: `R$ ${(stats.allTime.revenue / 100).toFixed(2)}`,
          subtitle: `${stats.allTime.sales} vendas totais`,
          type: 'default'
        });
        statsGrid.appendChild(totalCard);

        // Card: Pendentes
        const pendingCard = createStatCard({
          icon: '‚è≥',
          label: 'Pagamentos Pendentes',
          value: stats.pending,
          subtitle: 'aguardando confirma√ß√£o',
          type: 'warning'
        });
        statsGrid.appendChild(pendingCard);

        // Mostra a se√ß√£o
        dashboardSection.style.display = 'block';
      } catch (error) {
        if (error.message !== 'Sess√£o expirada') {
          console.error('Erro ao carregar estat√≠sticas:', error);
        }
      }
    }

    // Cria um card de estat√≠stica
    function createStatCard({ icon, label, value, subtitle, type, change }) {
      const card = document.createElement('div');
      card.className = `stat-card ${type || ''}`;

      const iconDiv = document.createElement('div');
      iconDiv.className = 'stat-icon';
      iconDiv.textContent = icon;

      const labelDiv = document.createElement('div');
      labelDiv.className = 'stat-label';
      labelDiv.textContent = label;

      const valueDiv = document.createElement('div');
      valueDiv.className = 'stat-value';
      valueDiv.textContent = value;

      const subtitleDiv = document.createElement('div');
      subtitleDiv.className = 'stat-subtitle';
      subtitleDiv.textContent = subtitle;

      card.appendChild(iconDiv);
      card.appendChild(labelDiv);
      card.appendChild(valueDiv);
      card.appendChild(subtitleDiv);

      // Adiciona mudan√ßa percentual se fornecida
      if (change !== undefined && change !== null) {
        const changeDiv = document.createElement('div');
        changeDiv.className = `stat-change ${change >= 0 ? 'positive' : 'negative'}`;
        const arrow = change >= 0 ? '‚Üë' : '‚Üì';
        changeDiv.textContent = `${arrow} ${Math.abs(change).toFixed(1)}% vs m√™s anterior`;
        card.appendChild(changeDiv);
      }

      return card;
    }

    // Calcula a mudan√ßa percentual
    function calculatePercentChange(oldValue, newValue) {
      if (oldValue === 0) return newValue > 0 ? 100 : 0;
      return ((newValue - oldValue) / oldValue) * 100;
    }

    window.onload = () => {
      initializeCollapse();
      loadStatistics();
      loadPaymentSettings();
      loadProducts();
      carregarMesAno();
      loadHistory();
    };

    

  
    // NOVO: C√≥digo para inicializar o Firebase e gerenciar notifica√ß√µes

    
       // CORRE√á√ÉO: Service Worker registration global para passar ao Firebase
    let swRegistration = null;

    // NOVO: Script para registrar o Service Worker
    // CORRE√á√ÉO: Espera o Service Worker estar pronto antes de usar
    async function registerServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        console.warn('Service Worker n√£o suportado neste navegador');
        return null;
      }

      try {
        // Registra o Service Worker
        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
        console.log('Service Worker registrado:', registration);

        // CR√çTICO: Aguarda Service Worker estar pronto
        await navigator.serviceWorker.ready;
        console.log('Service Worker est√° ativo e pronto');

        return registration;

      } catch (error) {
        console.error('Falha ao registrar Service Worker:', error);
        return null;
      }
    }

    // CORRIGIDO: Busca configura√ß√£o do Firebase do backend ao inv√©s de hardcoded
    let messaging;

    async function initializeFirebase() {
      try {
        // CORRE√á√ÉO: Registra e aguarda Service Worker ANTES de inicializar Firebase
        swRegistration = await registerServiceWorker();

        if (!swRegistration) {
          throw new Error('Service Worker n√£o p√¥de ser registrado');
        }

        const response = await fetch('/api/firebase-config');
        if (!response.ok) {
          throw new Error('Erro ao buscar configura√ß√£o do Firebase');
        }
        const config = await response.json();

        // Remove vapidKey do config principal
        const { vapidKey, ...firebaseConfig } = config;

        firebase.initializeApp(firebaseConfig);
        if (typeof console !== 'undefined' && console.log) {
          console.log('[Firebase JS] SDK do Firebase inicializado.');
        }

        messaging = firebase.messaging();

        // Escuta por notifica√ß√µes recebidas em primeiro plano
        messaging.onMessage((payload) => {
          if (typeof console !== 'undefined' && console.log) {
            console.log('[Firebase JS] MENSAGEM RECEBIDA EM PRIMEIRO PLANO: ', payload);
          }
          // Mostra toast ao inv√©s de alert
          showToast(
            `${payload.notification.title}: ${payload.notification.body}`,
            'success'
          );
        });

        return vapidKey;
      } catch (error) {
        if (typeof console !== 'undefined' && console.error) {
          console.error('Erro ao inicializar Firebase:', error);
        }
        showToast('Erro ao inicializar notifica√ß√µes', 'error');
        return null;
      }
    }

    function requestNotificationPermission(vapidKey) {
      if (!vapidKey || !messaging) {
        showToast('Firebase n√£o est√° configurado corretamente', 'error');
        return;
      }

      // CORRE√á√ÉO: Valida que Service Worker est√° pronto
      if (!swRegistration) {
        showToast('Service Worker n√£o est√° pronto. Recarregue a p√°gina.', 'error');
        return;
      }

      if (typeof console !== 'undefined' && console.log) {
        console.log('Solicitando permiss√£o para notifica√ß√µes...');
      }

      Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
          if (typeof console !== 'undefined' && console.log) {
            console.log('Permiss√£o para notifica√ß√£o concedida.');
          }

          // CORRE√á√ÉO: Passa Service Worker registration para getToken
          messaging.getToken({
            vapidKey: vapidKey,
            serviceWorkerRegistration: swRegistration
          }).then((currentToken) => {
            if (currentToken) {
              if (typeof console !== 'undefined' && console.log) {
                console.log('[Firebase JS] Token obtido:', currentToken);
              }
              sendTokenToServer(currentToken);
              showToast('Notifica√ß√µes ativadas com sucesso!', 'success');
            } else {
              if (typeof console !== 'undefined' && console.error) {
                console.error('[Firebase JS] N√£o foi poss√≠vel obter o token.');
              }
              showToast('Erro ao obter token de notifica√ß√£o', 'error');
            }
          }).catch((err) => {
            if (typeof console !== 'undefined' && console.error) {
              console.error('[Firebase JS] Erro ao obter token:', err);
            }
            showToast('Erro ao configurar notifica√ß√µes: ' + err.message, 'error');
          });

        } else {
          if (typeof console !== 'undefined' && console.warn) {
            console.warn('[Firebase JS] Permiss√£o negada.');
          }
          showToast('Permiss√£o para notifica√ß√µes negada', 'warning');
        }
      });
    }

    // Fun√ß√£o para enviar o token para o seu backend
    // MODIFICADO: Fun√ß√£o para enviar o token para o seu backend agora usa authenticatedFetch
    async function sendTokenToServer(token) {
      try {
        const response = await authenticatedFetch('/api/devices', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ token: token }),
        });
        const data = await response.json();
        console.log('Resposta do servidor ao registrar dispositivo:', data);
      } catch (err) {
        if (err.message !== 'Sess√£o expirada') {
          console.error('Erro ao enviar token para o servidor:', err);
        }
      }
    }

    // CORRIGIDO: Inicializa Firebase e configura bot√£o de notifica√ß√µes
    let firebaseVapidKey = null;

    // Inicializa Firebase quando a p√°gina carregar
    initializeFirebase().then(vapidKey => {
      firebaseVapidKey = vapidKey;

      // Adiciona um bot√£o para o admin ativar as notifica√ß√µes
      const notificationButton = document.createElement('button');
      notificationButton.className = 'notification-button';
      notificationButton.textContent = 'üîî Ativar Notifica√ß√µes de Venda';
      notificationButton.onclick = () => requestNotificationPermission(firebaseVapidKey);
      // Insere o bot√£o ap√≥s o header
      const adminHeader = document.querySelector('.admin-header');
      adminHeader.insertAdjacentElement('afterend', notificationButton);
    });
    
  

  </script>
</body>
</html>